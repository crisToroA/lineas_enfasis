<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Profesor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../CSS/teacher¬¥s_dashboard.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
</head>

<body>

  <!-- Header -->
  <div class="header">
    <img src="../IMG/logo.png" alt="Universidad de Medell√≠n">
      <div class = "button">
        <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
      </div>  
  </div>

  <!-- Secci√≥n de bienvenida -->
  <div class="container mt-5">
    <div class="card p-4 shadow-sm">
      <div class="row align-items-center">
        <div class="col-md-7">
          <h1 class="text-danger fw-bold mb-3">Bienvenido, Profesor/a</h1>
          <p class="fs-5">
            Gestione de manera eficiente sus cursos, cronogramas y calificaciones. 
            Su portal centralizado para el √©xito acad√©mico.
          </p>
        </div>
        <div class="col-md-5 text-center">
          <img src="https://previews.123rf.com/images/michaeljung/michaeljung0906/michaeljung090600290/5125275-teacher.jpg" class="img-fluid rounded shadow-sm">
        </div>
      </div>
    </div>
  </div>

  <!-- Pesta√±as de navegaci√≥n -->
  <div class="container mt-4">
    <ul class="nav nav-tabs border-bottom border-2">
      <li class="nav-item">
        <button class="nav-link active fw-semibold" id="tab-cronogramas" onclick="mostrarSeccion('cronogramas')">Cronogramas</button>
      </li>
      <li class="nav-item">
        <button class="nav-link fw-semibold" id="tab-calificaciones" onclick="mostrarSeccion('calificaciones')">Calificaciones</button>
      </li>
      <li class="nav-item">
        <button class="nav-link fw-semibold" id="tab-reportes" onclick="mostrarSeccion('reportes')">Reportes</button>
      </li>
    </ul>

    <!-- Secci√≥n Cronogramas -->
    <div id="cronogramas" class="mt-4">
      <div class="row">
        <!-- Mis cursos -->
        <div class="col-md-6 mb-4">
          <h3 class="text-danger mb-3">Mis Cursos y Horarios</h3>
          <div class="d-grid gap-3">
            <div class="p-3 border rounded bg-light border-danger-subtle">
              <b>Introducci√≥n a la Programaci√≥n</b><br>
              Lunes 10:00‚Äì12:00 (Aula B2)
            </div>
            <div class="p-3 border rounded bg-white">
              <b>√Ålgebra Lineal Aplicada</b><br>
              Martes 14:00‚Äì16:00 (Aula C3)
            </div>
            <div class="p-3 border rounded bg-white">
              <b>√âtica Profesional</b><br>
              Mi√©rcoles 08:00‚Äì10:00 (Aula A1)
            </div>
            <div class="p-3 border rounded bg-white">
              <b>Filosof√≠a de la Ciencia</b><br>
              Jueves 11:00‚Äì13:00 (Aula B1)
            </div>
          </div>
        </div>

        <!-- Cronograma -->
        <div class="col-md-6">
          <h3 class="text-danger mb-3">Visualizar Cronograma</h3>
          <div class="calendar-container shadow-sm p-3 rounded bg-white">
            <div id="calendar"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- üßæ Secci√≥n Calificaciones -->
    <div id="calificaciones" class="mt-4 d-none">
      <h3 class="text-danger mb-3">Gesti√≥n de Calificaciones</h3>
      <p>Aqu√≠ podr√° ingresar y revisar las notas de sus estudiantes.</p>
      <div class="alert alert-info">Funcionalidad en desarrollo...</div>
    </div>

    <!-- üìä Secci√≥n Reportes -->
    <div id="reportes" class="mt-4 d-none">
      <h3 class="text-danger mb-3">Reportes</h3>
      <p>Genere reportes consolidados sobre el progreso acad√©mico de sus cursos.</p>
      <div class="alert alert-secondary">M√≥dulo a√∫n no implementado.</div>
    </div>
  </div>

  <!-- Script para cambiar pesta√±as -->
  <script>
    // A√±adir variables globales y utilidades
    const CURRENT_PROF_ID = parseInt(localStorage.getItem('currentUserId') || 0, 10);
    function mostrarSeccion(seccion) {
      const secciones = ['cronogramas', 'calificaciones', 'reportes'];
      secciones.forEach(id => {
        document.getElementById(id).classList.add('d-none');
        const tab = document.getElementById('tab-' + id);
        if (tab) tab.classList.remove('active');
      });
      document.getElementById(seccion).classList.remove('d-none');
      const sel = document.getElementById('tab-' + seccion);
      if (sel) sel.classList.add('active');
    }

    // Cargar cursos asignados al profesor y poblar secci√≥n "Mis Cursos"
    async function cargarCursosProfesor() {
      if (!CURRENT_PROF_ID) return;
      try {
        const res = await fetch(`../php/coordinador_actions.php?action=list_mis_cursos_profesor&profesor_id=${CURRENT_PROF_ID}`, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const j = await res.json();
        if (!j.success) {
          console.error('Error list_mis_cursos_profesor', j);
          return;
        }
        const cursos = j.data || [];
        const container = document.querySelector('.container .row .col-md-6 .d-grid');
        if (container) {
            container.innerHTML = '';
            cursos.forEach(c => {
                const div = document.createElement('div');
                div.className = 'p-3 border rounded bg-white';
                const horario = c.dia ? `${c.dia} ${c.hora_inicio ? c.hora_inicio.substring(0,5) : ''}‚Äì${c.hora_fin ? c.hora_fin.substring(0,5) : ''}` : 'Horario no asignado';
                div.innerHTML = `<b>${c.nombre}</b><br>${c.semestre} ‚Ä¢ ${c.codigo} <br><small>${horario}</small>
                                 <div style="margin-top:8px;"><button class="btn btn-sm btn-outline-primary" onclick="verAlumnosYCalificaciones(${c.id}, '${escapeHtml(c.nombre)}')">Ver Alumnos / Calificaciones</button>
                                 <button class="btn btn-sm btn-outline-secondary" style="margin-left:6px;" onclick="abrirReporte(${c.id}, '${escapeHtml(c.nombre)}')">Reportar</button></div>`;
                container.appendChild(div);
            });
        }
        // actualizar calendario con eventos
        if (window.calendar) {
            window.calendar.removeAllEvents();
            cursos.forEach(c => {
                if (c.dia && c.hora_inicio) {
                    // crear evento semanal: FullCalendar puede usar dow + time; aqu√≠ simplificamos creando eventos pr√≥ximos (pr√≥xima semana d√≠a correspondiente)
                    const dowMap = { 'Lunes':1,'Martes':2,'Mi√©rcoles':3,'Miercoles':3,'Jueves':4,'Viernes':5,'S√°bado':6,'Sabado':6,'Domingo':0 };
                    const dow = dowMap[c.dia] ?? null;
                    if (dow !== null) {
                        // crear evento recurrente simple (usando daysOfWeek)
                        window.calendar.addEvent({
                            title: c.nombre,
                            daysOfWeek: [dow],
                            startTime: c.hora_inicio || '08:00:00',
                            endTime: c.hora_fin || '10:00:00',
                            extendedProps: { curso_id: c.id }
                        });
                    }
                }
            });
        }
      } catch (err) {
        console.error('cargarCursosProfesor error', err);
      }
    }

    // Inicializar calendario con FullCalendar (mejor apariencia)
    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      window.calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'es',
        height: 560,
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay' },
        allDaySlot: false,
        slotMinTime: "06:00:00",
        slotMaxTime: "22:00:00",
        nowIndicator: true,
        eventClick: function(info) {
          // al hacer click en evento, abrir secci√≥n calificaciones para ese curso
          const cursoId = info.event.extendedProps.curso_id;
          if (cursoId) {
            mostrarSeccion('calificaciones');
            verAlumnosYCalificaciones(cursoId, info.event.title);
          }
        }
      });
      window.calendar.render();
      // cargar datos
      cargarCursosProfesor();
    });

    // Ver alumnos y mostrar tabla de calificaciones editable
    async function verAlumnosYCalificaciones(cursoId, cursoNombre) {
      mostrarSeccion('calificaciones');
      const cont = document.getElementById('calificaciones');
      cont.innerHTML = `<h3 class="text-danger mb-3">Gesti√≥n de Calificaciones ‚Äî ${escapeHtml(cursoNombre || '')}</h3>
                        <div id="calificacionesInner"><p>Cargando estudiantes...</p></div>`;
      try {
        const res = await fetch(`../php/coordinador_actions.php?action=list_estudiantes_curso&curso_id=${cursoId}`, { cache: 'no-store' });
        const j = await res.json();
        if (!j.success) {
          document.getElementById('calificacionesInner').innerHTML = '<div class="alert alert-danger">Error al cargar estudiantes.</div>';
          return;
        }
        const rows = j.data || [];
        const html = ['<table class="table table-striped"><thead><tr><th>#</th><th>Estudiante</th><th>Documento</th><th>Nota</th><th>Acci√≥n</th></tr></thead><tbody>'];
        rows.forEach((s, idx) => {
            const notaVal = (s.nota !== null && s.nota !== undefined) ? s.nota : '';
            html.push(`<tr>
                <td>${idx+1}</td>
                <td>${escapeHtml(s.nombre || '')}</td>
                <td>${escapeHtml(s.documento || '')}</td>
                <td><input type="number" min="0" max="100" step="0.01" class="form-control form-control-sm" id="nota_${s.estudiante_id}" value="${notaVal}"></td>
                <td><button class="btn btn-sm btn-success" onclick="guardarNota(${cursoId}, ${s.estudiante_id})">Guardar</button></td>
            </tr>`);
        });
        html.push('</tbody></table>');
        document.getElementById('calificacionesInner').innerHTML = html.join('');
      } catch (err) {
        console.error('verAlumnosYCalificaciones error', err);
        document.getElementById('calificacionesInner').innerHTML = '<div class="alert alert-danger">Error de conexi√≥n.</div>';
      }
    }

    // Guardar nota
    async function guardarNota(cursoId, estudianteId) {
      const input = document.getElementById('nota_' + estudianteId);
      const val = input ? input.value.trim() : '';
      const fd = new FormData();
      fd.append('action', 'guardar_nota');
      fd.append('curso_id', cursoId);
      fd.append('estudiante_id', estudianteId);
      fd.append('nota', val);
      try {
        const res = await fetch('../php/coordinador_actions.php', { method: 'POST', body: fd });
        const j = await res.json();
        if (j.success) {
          alert('Nota guardada.');
        } else {
          alert('No se pudo guardar la nota: ' + (j.message || 'error'));
          console.warn('guardar_nota', j);
        }
      } catch (err) {
        console.error('guardarNota error', err);
        alert('Error de conexi√≥n al guardar.');
      }
    }

    // Abrir formulario de reporte para el curso
    function abrirReporte(cursoId, cursoNombre) {
      mostrarSeccion('reportes');
      const cont = document.getElementById('reportes');
      cont.innerHTML = `<h3 class="text-danger mb-3">Reportes ‚Äî ${escapeHtml(cursoNombre || '')}</h3>
        <div><label>Tipo de reporte</label>
          <select id="reporteTipo" class="form-select" style="max-width:320px;">
            <option value="inasistencias">Acumulaci√≥n de inasistencias</option>
            <option value="notas">Reporte de notas</option>
            <option value="otro">Otro</option>
          </select></div>
        <div style="margin-top:10px;">
          <label>Contenido</label>
          <textarea id="reporteContenido" class="form-control" style="min-height:120px;"></textarea>
        </div>
        <div style="margin-top:12px;">
          <button class="btn btn-primary" onclick="enviarReporte(${cursoId})">Enviar reporte al coordinador</button>
        </div>
        <div id="reporteFeedback" style="margin-top:10px;"></div>`;
    }

    // Enviar reporte al backend
    async function enviarReporte(cursoId) {
      const tipo = document.getElementById('reporteTipo').value;
      const contenido = document.getElementById('reporteContenido').value.trim();
      if (!contenido) { alert('Escriba el contenido del reporte'); return; }
      const fd = new FormData();
      fd.append('action','enviar_reporte_coordinador');
      fd.append('curso_id', cursoId);
      fd.append('tipo', tipo);
      fd.append('contenido', contenido);
      fd.append('enviado_por', CURRENT_PROF_ID);
      try {
        const res = await fetch('../php/coordinador_actions.php', { method: 'POST', body: fd });
        const j = await res.json();
        const fb = document.getElementById('reporteFeedback');
        if (j.success) {
          fb.innerHTML = '<div class="alert alert-success">Reporte enviado correctamente.</div>';
        } else {
          fb.innerHTML = '<div class="alert alert-danger">Error al enviar el reporte.</div>';
          console.warn('enviar_reporte_coordinador', j);
        }
      } catch (err) {
        console.error('enviarReporte error', err);
        alert('Error de conexi√≥n al enviar reporte.');
      }
    }

    // escape helper
    function escapeHtml(text) {
      if (!text) return '';
      return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }

    // M√©todo cerrar sesi√≥n actualizado
    function cerrarSesion() {
      localStorage.removeItem('currentUserId');
      localStorage.removeItem('currentUserName');
      window.location.href = '../index.html';
    }
  </script>

  <!-- Chatbot widget -->
  <div class="chatbot-container">
    <div class="chatbot-header">
      <h5>Asistente Virtual</h5>
      <button class="btn-close" onclick="toggleChatbot()"></button>
    </div>
    <div class="chatbot-body" id="chatBody">
        <div class="chatbot-msg bot"><span class="bubble">Hola, escribe "menu" para ver las opciones de ayuda y dudas frecuentes para profesores.</span></div>
    </div>
    <div class="chatbot-input">
      <input type="text" id="userInput" placeholder="Escribe tu mensaje...">
      <button class="btn btn-primary" onclick="enviarMensaje()">Enviar</button>
    </div>
  </div>

  <!-- Script para el chatbot -->
  <script>
    function toggleChatbot() {
      const cont = document.querySelector('.chatbot-container');
      cont.classList.toggle('active');
      if (cont.classList.contains('active')) {
        setTimeout(() => { cont.querySelector('#userInput').focus(); }, 300);
      }
    }

    // Enviar mensaje del usuario
    function enviarMensaje() {
      const input = document.getElementById('userInput');
      const texto = input.value.trim();
      if (!texto) return;
      agregarMensaje('user', texto);
      input.value = '';

      // Respuestas b√°sicas del bot (simulaci√≥n)
      setTimeout(() => {
        let respuesta = 'No entiendo tu pregunta.';
        if (texto.toLowerCase().includes('menu')) {
          respuesta = 'Opciones disponibles: 1. Cronograma 2. Calificaciones 3. Reportes';
        } else if (texto.toLowerCase().includes('hola')) {
          respuesta = '¬°Hola! ¬øEn qu√© puedo ayudarte hoy?';
        }
        agregarMensaje('bot', respuesta);
      }, 600);
    }

    // Agregar mensaje al chat
    function agregarMensaje(tipo, texto) {
      const div = document.createElement('div');
      div.className = `chatbot-msg ${tipo}`;
      div.innerHTML = `<span class="bubble">${escapeHtml(texto)}</span>`;
      document.getElementById('chatBody').appendChild(div);
      setTimeout(() => { div.scrollIntoView({ behavior: 'smooth' }); }, 50);
    }
  </script>

</body>
</html>
