<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Acad√©mica - Universidad de Medell√≠n</title>
    <link rel="stylesheet" href="../CSS/coordinador_dashboard.css">
    <link rel="stylesheet" href="../CSS/chatbot.css">

</head>
<body>
    <!-- Header -->
    <div class="header">
        <img src="../IMG/logo.png" alt="Universidad de Medell√≠n">
          <div class = "button">
            <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
          </div>  
      </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Title -->
        <h1 class="page-title">
            Gesti√≥n Acad√©mica de L√≠neas de √ânfasis
            <img src="https://previews.123rf.com/images/michaeljung/michaeljung0906/michaeljung090600290/5125275-teacher.jpg" alt="Icon" class="title-icon">
        </h1>

        <!-- Zona de diagn√≥stico de BD -->
        <div id="dbDiag" style="margin-bottom:18px;color:#666;font-size:14px;">Comprobando conexi√≥n a base de datos...</div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('registrar')">Registrar Curso</button>
            <button class="nav-tab" onclick="showSection('validar')">Validar Solicitudes</button>
            <button class="nav-tab" onclick="showSection('seguimiento')">Seguimiento Aprobaciones</button>
        </div>

        <!-- Registrar Curso Section -->
        <div id="registrar" class="content-section active">
            <!-- Reemplazado: tarjeta de registro con dise√±o mejorado -->
            <div class="card card--elevated">
                <div class="card-header">
                    <h2 class="section-title">Registrar Nuevo Curso</h2>
                    <p class="card-subtitle">Complete la informaci√≥n del curso. El comentario del profesor es opcional.</p>
                </div>

                <form id="registroCursoForm" class="registro-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label><span class="label-icon">üìò</span> Nombre del Curso</label>
                            <input type="text" id="curso_nombre" name="nombre" placeholder="Ej: C√°lculo Diferencial" required>
                            <div class="helper-text">Nombre descriptivo y claro (m√°x. 150 caracteres).</div>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üîñ</span> C√≥digo del Curso</label>
                            <input type="text" id="curso_codigo" name="codigo" placeholder="Ej: MAT101" required>
                            <div class="helper-text">C√≥digo √∫nico (sin espacios).</div>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üìÖ</span> Semestre</label>
                            <select id="curso_semestre" name="semestre" required>
                                <option value="">Seleccione...</option>
                                <option>2024-1</option>
                                <option>2024-2</option>
                                <option>2025-1</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üë©‚Äçüè´</span> Profesor responsable</label>
                            <select id="profesorSelect" name="profesor_id" required>
                                <option value="">Cargando profesores...</option>
                            </select>
                            <div class="helper-text">Seleccione el docente que dictar√° el curso.</div>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üìö</span> L√≠nea de √ânfasis</label>
                            <select id="lineaEnfasisSelect" name="linea_enfasis_id" required>
                                <option value="">Cargando l√≠neas de √©nfasis...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üìù</span> Notas/Observaciones (opcional)</label>
                            <input type="text" id="curso_observaciones" name="observaciones" placeholder="Ej: Requiere laboratorio complementario">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-submit">Registrar Curso</button>
                        <div id="registroFeedback" class="feedback" aria-live="polite" style="display:none;"></div>
                    </div>
                </form>
            </div>
            <!-- Eliminada la secci√≥n de "Cursos Registrados" por petici√≥n -->
        </div>

        <!-- Validar Solicitudes Section -->
        <div id="validar" class="content-section">
            <div class="card">
                <h2 class="section-title">Validaci√≥n de Solicitudes</h2>
                <div class="table-container" id="solicitudesPendientes">
                    <table id="tablaSolicitudes" style="width:100%;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Remitente</th>
                                <th>Rol</th>
                                <th>Tipo</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Se carga din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Seguimiento Aprobaciones Section -->
        <div id="seguimiento" class="content-section">
			<div class="filter-group">
				<label>Filtrar por Semestre:</label>
				<select>
					<option>2024-1</option>
					<option>2024-2</option>
					<option>2025-1</option>
				</select>
			</div>

			<div class="seguimiento-container">
				<!-- Lista de Solicitudes procesadas -->
				<div class="solicitudes-list" id="contSolicitudesProcesadas">
					<h2 class="section-title">Listado de Solicitudes (Aprobadas / Rechazadas)</h2>
					<div id="listaSeguimiento">
						<!-- Se llenar√° din√°micamente -->
					</div>
				</div>

				<!-- Panel detalle (ahora lateral y oculto por defecto) -->
				<div class="detalles-panel" id="panelDetalleSeguimiento">
					<button class="detalle-close" id="cerrarPanelDetalle">‚Üê Volver</button>
					<h2 class="section-title" style="margin-top:0;">Detalle</h2>

					<div id="detalleContentPanel">
						<p><b>Tipo:</b> <span id="detalleTipoPanel">-</span></p>
						<p><b>Remitente:</b> <span id="detalleRemitentePanel">-</span></p>
						<p><b>Rol:</b> <span id="detalleRolPanel">-</span></p>
						<p><b>Fecha env√≠o:</b> <span id="detalleFechaPanel">-</span></p>
						<p><b>Estado:</b> <span id="detalleEstadoPanel">-</span></p>
						<p><b>Descripci√≥n (remitente):</b></p>
						<p id="detalleDescripcionPanel">-</p>

						<p><b>Comentario del coordinador:</b></p>
						<p id="detalleComentarioCoordinadorPanel">-</p>

						<p><b>Aprobado por:</b> <span id="detalleAprobadorPanel">-</span></p>
						<p><b>Fecha de procesado:</b> <span id="detalleFechaProcesamientoPanel">-</span></p>
					</div>
				</div>
			</div>
		</div>

	<!-- Modal detalle / validaci√≥n (reemplazado por versi√≥n con vistas) -->
	<div id="modalDetalleSolicitud" class="modal-overlay" style="display:none;">
		<div class="modal-card">
			<div class="modal-header">
				<!-- la flecha atr√°s: ahora button type=button y aria -->
				<button id="modalBack" class="modal-back" type="button" aria-label="Volver" style="display:none;">‚Üê</button>
				<h3 id="modalTitle" style="margin:0;">Detalle de Solicitud</h3>
				<!-- cerrar: button type=button -->
				<button id="modalClose" class="modal-close" type="button" aria-label="Cerrar">‚úï</button>
			</div>

			<!-- Vista: Detalles -->
			<div id="modalDetails" class="modal-body">
				<p><b>Tipo:</b> <span id="detalleTipo">-</span></p>
				<p><b>Remitente:</b> <span id="detalleRemitente">-</span></p>
				<p><b>Rol:</b> <span id="detalleRol">-</span></p>
				<p><b>Fecha env√≠o:</b> <span id="detalleFecha">-</span></p>
				<p><b>Estado:</b> <span id="detalleEstado">-</span></p>
				<p><b>Descripci√≥n (remitente):</b></p>
				<p id="detalleDescripcion">-</p>

				<div id="detalleComentarioExistente" style="margin-top:10px;display:none;">
					<p><b>Comentario del coordinador:</b></p>
					<p id="detalleComentarioCoordinador">-</p>
				</div>

				<div style="display:flex;gap:12px;margin-top:16px;">
					<button id="btnAprobar" class="btn-action btn-aprobar" type="button">Aprobar</button>
					<button id="btnRechazar" class="btn-action btn-rechazar" type="button">Rechazar</button>
				</div>
			</div>

			<!-- Vista: Acci√≥n (comentar y enviar) -->
			<div id="modalAction" class="modal-body" style="display:none;">
				<p style="margin-top:0;"><b>Acci√≥n:</b> <span id="accionTipo">-</span></p>
				<label for="actionComment"><b>Comentario obligatorio:</b></label>
				<textarea id="actionComment" style="width:100%;min-height:140px;padding:8px;margin-top:8px;border:1px solid #ddd;border-radius:6px;"></textarea>

				<div style="display:flex;gap:12px;margin-top:12px;">
					<button id="submitActionBtn" class="btn-action btn-aprobar action-submit" type="button">Enviar y Aprobar</button>
					<button id="cancelActionBtn" class="btn-action btn-rechazar action-cancel" type="button">Cancelar</button>
				</div>
			</div>
		</div>
	</div>

    <script>
        // A√±adido: variables globales necesarias
        var _currentSolicitudId = null;
        var _currentAccion = null;
        var CURRENT_USER_ID = parseInt(localStorage.getItem('currentUserId') || 0, 10);

        function cerrarSesion() {
            // redirige a la p√°gina de inicio (y limpia sesi√≥n local)
            localStorage.removeItem('currentUserId');
            localStorage.removeItem('currentUserName');
            window.location.href = '../index.html';
        }

        // Reemplazo de showSection para no depender de event.target (evita errores JS que cancelan listeners)
        function showSection(sectionId) {
            // Hide all sections
            var sections = document.querySelectorAll('.content-section');
            sections.forEach(function(section) {
                section.classList.remove('active');
            });

            // Remove active class from all tabs
            var tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Activar la pesta√±a correspondiente seg√∫n sectionId (mapeo expl√≠cito)
            if (sectionId === 'registrar') {
                document.querySelector('.nav-tab:nth-child(1)').classList.add('active');
            } else if (sectionId === 'validar') {
                document.querySelector('.nav-tab:nth-child(2)').classList.add('active');
            } else if (sectionId === 'seguimiento') {
                document.querySelector('.nav-tab:nth-child(3)').classList.add('active');
            }
        }

        // Util: parsear respuesta segura
async function parseJsonResponse(response) {
    const text = await response.text();
    try {
        return JSON.parse(text);
    } catch (err) {
        console.error('Respuesta no JSON del servidor:', text);
        throw new Error('Respuesta inv√°lida del servidor');
    }
}

// Funci√≥n para registrar curso (ajustada: ya no recarga la lista de cursos)
document.getElementById('registroCursoForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const nombre = document.getElementById('curso_nombre').value.trim();
    const codigo = document.getElementById('curso_codigo').value.trim();
    const semestre = document.getElementById('curso_semestre').value;
    const profesor_id = document.getElementById('profesorSelect').value;
    const linea_enfasis_id = document.getElementById('lineaEnfasisSelect').value;

    if (!nombre || !codigo || !semestre || !profesor_id || !linea_enfasis_id) {
        alert('Complete todos los campos del formulario.');
        return;
    }

    const formData = new FormData();
    formData.append('action', 'registrar_curso');
    formData.append('nombre', nombre);
    formData.append('codigo', codigo);
    formData.append('semestre', semestre);
    formData.append('profesor_id', profesor_id);
    formData.append('linea_enfasis_id', linea_enfasis_id);

    try {
        const res = await fetch('../php/coordinador_actions.php', {
            method: 'POST',
            body: formData
        });
        if (!res.ok) {
            // intentar leer cuerpo para depuraci√≥n
            const txt = await res.text();
            console.error('Error HTTP al registrar curso:', res.status, txt);
            alert('Error al registrar curso. Revise la consola para m√°s detalles.');
            return;
        }
        const resp = await parseJsonResponse(res);
        if (resp.success) {
            alert('Curso registrado correctamente.');
            this.reset();
            // No se llama a cargarCursos porque la vista de lista fue removida
        } else {
            console.error('Error registrar curso (back):', resp);
            alert('Error: ' + (resp.message || 'No fue posible registrar el curso.'));
        }
    } catch (err) {
        console.error('Error registrar curso', err);
        alert('Error al procesar la solicitud. Revise la consola para m√°s detalles.');
    }
});

        // Cargar solicitudes en tabla
        function cargarSolicitudes() {
            fetch('../php/coordinador_actions.php?action=obtener_solicitudes')
            .then(response => response.json())
            .then(solicitudes => {
                const tbody = document.querySelector('#tablaSolicitudes tbody');
                if (!Array.isArray(solicitudes) || solicitudes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">No hay solicitudes registradas.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                solicitudes.forEach(solicitud => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${solicitud.id}</td>
                        <td>${solicitud.remitente}</td>
                        <td>${solicitud.rol}</td>
                        <td>${solicitud.tipo}</td>
                        <td>${solicitud.fecha}</td>
                        <td>
                            <span class="status-badge status-${solicitud.estado}">${solicitud.estado.charAt(0).toUpperCase() + solicitud.estado.slice(1)}</span>
                        </td>
                        <td>
                            <button class="btn-action" style="padding:4px 12px;" onclick="verDetalleSolicitud(${solicitud.id})">Ver</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(() => {
                document.querySelector('#tablaSolicitudes tbody').innerHTML = '<tr><td colspan="7">Error al cargar las solicitudes.</td></tr>';
            });
        }

        // Mostrar modal con detalle de solicitud (actualizado)
    function verDetalleSolicitud(id) {
        fetch(`../php/coordinador_actions.php?action=detalle_solicitud&id=${id}`)
        .then(res => res.json())
        .then(data => {
            _currentSolicitudId = data.id ?? id;
            _currentAccion = null;
            // Llenar campos de detalle
            document.getElementById('detalleTipo').textContent = data.tipo || '-';
            document.getElementById('detalleRemitente').textContent = data.remitente || '-';
            document.getElementById('detalleRol').textContent = data.rol || '-';
            document.getElementById('detalleFecha').textContent = data.fecha || '-';
            document.getElementById('detalleEstado').textContent = (data.estado ? data.estado.charAt(0).toUpperCase() + data.estado.slice(1) : '-');
            document.getElementById('detalleDescripcion').textContent = data.descripcion || '(Sin detalles)';

            // Comentario existente
            if (data.comentario_coordinador && data.comentario_coordinador.trim() !== '') {
                document.getElementById('detalleComentarioExistente').style.display = 'block';
                document.getElementById('detalleComentarioCoordinador').textContent = data.comentario_coordinador;
            } else {
                document.getElementById('detalleComentarioExistente').style.display = 'none';
                document.getElementById('detalleComentarioCoordinador').textContent = '-';
            }

            // asegurar vista detalles visible y acci√≥n oculta
            document.getElementById('modalDetails').style.display = 'block';
            document.getElementById('modalAction').style.display = 'none';
            document.getElementById('modalBack').style.display = 'none';
            document.getElementById('actionComment').value = '';

            // conectar botones para iniciar acci√≥n
            document.getElementById('btnAprobar').onclick = () => startAccion('aprobada');
            document.getElementById('btnRechazar').onclick = () => startAccion('rechazada');

            // abrir modal
            document.getElementById('modalDetalleSolicitud').style.display = 'flex';
        })
        .catch(err => {
            console.error('Error detalle solicitud', err);
            alert('Error al cargar detalle de la solicitud.');
        });
    }

    // iniciar flujo de acci√≥n: mostrar formulario de comentario
    function startAccion(estado) {
        _currentAccion = estado;
        // actualizar UI de acci√≥n
        document.getElementById('accionTipo').textContent = estado === 'aprobada' ? 'Aprobar' : 'Rechazar';
        document.getElementById('modalDetails').style.display = 'none';
        document.getElementById('modalAction').style.display = 'block';
        document.getElementById('modalBack').style.display = 'inline-block';
        // cambiar texto del bot√≥n de env√≠o seg√∫n acci√≥n
        const submitBtn = document.getElementById('submitActionBtn');
        submitBtn.textContent = (estado === 'aprobada') ? 'Enviar y Aprobar' : 'Enviar y Rechazar';
    };

    // volver desde vista acci√≥n a detalles
    document.getElementById('modalBack').addEventListener('click', () => {
        document.getElementById('modalAction').style.display = 'none';
        document.getElementById('modalDetails').style.display = 'block';
        document.getElementById('modalBack').style.display = 'none';
    });

    // cancelar acci√≥n (bot√≥n)
    document.getElementById('cancelActionBtn').addEventListener('click', () => {
        document.getElementById('actionComment').value = '';
        document.getElementById('modalAction').style.display = 'none';
        document.getElementById('modalDetails').style.display = 'block';
        document.getElementById('modalBack').style.display = 'none';
    });

    // env√≠o final de la acci√≥n con comentario
    document.getElementById('submitActionBtn').addEventListener('click', () => {
        const comentario = document.getElementById('actionComment').value.trim();
        if (!comentario) {
            alert('Por favor escriba un comentario antes de continuar.');
            return;
        }
        if (!_currentSolicitudId || !_currentAccion) {
            alert('Solicitud o acci√≥n inv√°lida.');
            return;
        }
        // llamar a la funci√≥n que procesa la solicitud (usa POST)
        const fd = new FormData();
        fd.append('action', 'validar_solicitud');
        fd.append('solicitud_id', _currentSolicitudId);
        fd.append('estado', _currentAccion);
        fd.append('comentario', comentario);
        // opcional: fd.append('aprobador_id', CURRENT_USER_ID); // si dispone de sesi√≥n

        fetch('../php/coordinador_actions.php', {
            method: 'POST',
            body: fd
        })
        .then(r => r.json())
        .then(resp => {
            if (resp.success) {
                mostrarRegistroFeedback('Solicitud procesada exitosamente.', true);
                cerrarModalDetalle();
                cargarSolicitudes();
                if (typeof cargarSeguimiento === 'function') cargarSeguimiento();
            } else {
                mostrarRegistroFeedback('No se pudo procesar la solicitud.', false);
            }
        })
        .catch(() => {
            mostrarRegistroFeedback('Error al conectar con el servidor.', false);
        });
    });

    // cerrar modal y limpiar estados
    function cerrarModalDetalle() {
        document.getElementById('modalDetalleSolicitud').style.display = 'none';
        _currentSolicitudId = null;
        _currentAccion = null;
        document.getElementById('actionComment').value = '';
        document.getElementById('modalBack').style.display = 'none';
}

        // Reemplazar la funci√≥n cargarLineasEnfasis por esta versi√≥n (ruta relativa y manejo de errores)
	function cargarLineasEnfasis() {
		const selectForm = document.getElementById('lineaEnfasisSelect');
		const selectFiltro = document.getElementById('filtroLineaEnfasis');
		if (selectForm) selectForm.innerHTML = '<option value="">Cargando l√≠neas de √©nfasis...</option>';
		if (selectFiltro) selectFiltro.innerHTML = '<option value="">Cargando...</option>';

		fetch('../php/coordinador_actions.php?action=list_lineas_enfasis', { cache: 'no-store' })
		.then(res => {
			if (!res.ok) throw new Error('HTTP ' + res.status);
			return res.json();
		})
		.then(data => {
			if (!Array.isArray(data) || data.length === 0) {
				if (selectForm) selectForm.innerHTML = '<option value="">No hay l√≠neas disponibles</option>';
				if (selectFiltro) selectFiltro.innerHTML = '<option value="">Todas</option>';
				return;
			}
			if (selectForm) {
				selectForm.innerHTML = '<option value="">Seleccione una l√≠nea de √©nfasis</option>';
				data.forEach(le => {
					const opt = document.createElement('option');
					opt.value = le.id;
					opt.textContent = le.nombre;
					selectForm.appendChild(opt);
				});
			}
			if (selectFiltro) {
				selectFiltro.innerHTML = '<option value="">Todas</option>';
				data.forEach(le => {
					const opt = document.createElement('option');
					opt.value = le.id;
					opt.textContent = le.nombre;
					selectFiltro.appendChild(opt);
				});
			}
		})
		.catch(err => {
			console.error('Error cargando l√≠neas de √©nfasis:', err);
			if (selectForm) selectForm.innerHTML = '<option value="">Error al cargar l√≠neas</option>';
			if (selectFiltro) selectFiltro.innerHTML = '<option value="">Todas</option>';
		});
	}

	// Reemplazado: funci√≥n cargarProfesores (sin dependencia del bot√≥n)
	async function cargarProfesores() {
		const select = document.getElementById('profesorSelect');
		if (!select) return;
		select.disabled = true;
		select.innerHTML = '<option value="">Cargando profesores...</option>';

		try {
			const res = await fetch('../php/coordinador_actions.php?action=list_profesores', { cache: 'no-store' });
			if (!res.ok) throw new Error('HTTP ' + res.status);
			const data = await res.json();

			if (!Array.isArray(data) || data.length === 0) {
				select.innerHTML = '<option value="">No se encontraron profesores</option>';
				select.disabled = false;
				return;
			}

			select.innerHTML = '<option value="">Seleccione un profesor</option>';
			data.forEach(prof => {
				const opt = document.createElement('option');
				opt.value = prof.id;
				opt.textContent = prof.nombre + (prof.documento ? ' (' + prof.documento + ')' : '');
				select.appendChild(opt);
			});
			select.disabled = false;
		} catch (err) {
			console.error('Error cargando profesores', err);
			select.innerHTML = '<option value="">Error al cargar profesores</option>';
			select.disabled = false;
		}
	}

    // A√±adir funci√≥n para cargar las solicitudes procesadas (seguimiento)
    async function cargarSeguimiento() {
        const cont = document.getElementById('listaSeguimiento');
        if (!cont) return;
        cont.innerHTML = '<p style="color:#666;">Cargando seguimiento...</p>';
        try {
            const res = await fetch('../php/coordinador_actions.php?action=list_solicitudes_procesadas', { cache: 'no-store' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            if (!Array.isArray(data) || data.length === 0) {
                cont.innerHTML = '<p>No hay solicitudes procesadas a√∫n.</p>';
                return;
            }
            // render sencillo
            cont.innerHTML = '';
            data.forEach(s => {
                const d = document.createElement('div');
                d.style.padding = '12px';
                d.style.borderBottom = '1px solid #f0f0f0';
                d.innerHTML = `<b>#${s.id}</b> ‚Äî ${s.tipo} ‚Äî <i>${s.estado}</i> ‚Äî ${s.fecha_procesamiento || s.fecha || '-'}
                               <div style="color:#444;margin-top:6px;">${s.descripcion || ''}</div>
                               <div style="color:#444;margin-top:6px;"><b>Respuesta:</b> ${s.comentario_coordinador ? s.comentario_coordinador : '<span style="color:#888">(sin comentario)</span>'}</div>
                               <div style="margin-top:8px;"><small>Aprobado por: ${s.aprobador_nombre || '‚Äî'}</small></div>`;
                cont.appendChild(d);
            });
        } catch (err) {
            console.error('cargarSeguimiento error', err);
            cont.innerHTML = '<p style="color:#c00;">Error al cargar seguimiento.</p>';
        }
    }

    // Ejecutar cargas al DOMContentLoaded para asegurar que los elementos existen
    document.addEventListener('DOMContentLoaded', function() {
		// Diagn√≥stico simple de BD: invoca action=diagnose_db y muestra resultado
    async function checkDb() {
        const el = document.getElementById('dbDiag');
        if (!el) return;
        el.textContent = 'Verificando base de datos...';
        try {
            const res = await fetch('../php/coordinador_actions.php?action=diagnose_db', { cache: 'no-store' });
            const txt = await res.text();
            let j;
            try { j = JSON.parse(txt); } catch (e) { el.innerHTML = '<span style="color:#c00">Respuesta inv√°lida del servidor. Revisa la consola.</span>'; console.error('diagnose_db non-json:', txt); return; }
            if (j.success) {
                const parts = [];
                if (j.database) parts.push('DB: <b>' + j.database + '</b>');
                if (j.counts) {
                    const cnts = Object.keys(j.counts).map(k => `${k}: ${j.counts[k] === null ? '<span style="color:#c00">-</span>' : j.counts[k]}`).join(' ‚Ä¢ ');
                    parts.push('Tablas: ' + cnts);
                }
                el.innerHTML = parts.join(' ‚Äî ');
            } else {
                el.innerHTML = '<span style="color:#c00">Diagn√≥stico fall√≥: ' + (j.error || 'sin detalle') + '</span>';
                console.error('diagnose_db error:', j);
            }
        } catch (err) {
            el.innerHTML = '<span style="color:#c00">Error al conectar con el servidor: ' + (err.message || '') + '</span>';
            console.error('checkDb fetch error', err);
        }
    }

    checkDb(); // <-- diagn√≥stico visible
		if (typeof cargarSolicitudes === 'function') cargarSolicitudes();
		if (typeof cargarProfesores === 'function') cargarProfesores();
		if (typeof cargarLineasEnfasis === 'function') cargarLineasEnfasis();
		if (typeof cargarSeguimiento === 'function') cargarSeguimiento(); // cargar seguimiento al inicio

        // mostrar feedback sencillo (usa #registroFeedback si existe)
        function mostrarRegistroFeedback(msg, ok) {
            const el = document.getElementById('registroFeedback');
            if (el) {
                el.style.display = 'block';
                el.textContent = msg;
                el.style.color = ok ? '#155724' : '#721c24';
                el.style.background = ok ? '#e6f4ea' : '#fbecec';
                setTimeout(() => { el.style.display = 'none'; }, ok ? 3000 : 6000);
            } else {
                alert(msg);
            }
        }

        // Registrar listeners del modal aqu√≠ (se asegura que los elementos existen)
        const modalBack = document.getElementById('modalBack');
        const modalClose = document.getElementById('modalClose');
        const cancelActionBtn = document.getElementById('cancelActionBtn');
        const submitActionBtn = document.getElementById('submitActionBtn');

        if (modalBack) {
            modalBack.addEventListener('click', () => {
                document.getElementById('modalAction').style.display = 'none';
                document.getElementById('modalDetails').style.display = 'block';
                modalBack.style.display = 'none';
            });
        }

        if (modalClose) {
            modalClose.addEventListener('click', () => {
                cerrarModalDetalle();
            });
        }

        if (cancelActionBtn) {
            cancelActionBtn.addEventListener('click', () => {
                document.getElementById('actionComment').value = '';
                document.getElementById('modalAction').style.display = 'none';
                document.getElementById('modalDetails').style.display = 'block';
                if (modalBack) modalBack.style.display = 'none';
            });
        }

        if (submitActionBtn) {
            submitActionBtn.addEventListener('click', async () => {
                const comentario = document.getElementById('actionComment').value.trim();
                if (!comentario) {
                    alert('Por favor escriba un comentario antes de continuar.');
                    return;
                }
                if (!_currentSolicitudId || !_currentAccion) {
                    alert('Solicitud o acci√≥n inv√°lida.');
                    return;
                }
                try {
                    const fd = new FormData();
                    fd.append('action', 'validar_solicitud');
                    fd.append('solicitud_id', _currentSolicitudId);
                    fd.append('estado', _currentAccion);
                    fd.append('comentario', comentario);
                    // a√±adir aprobador_id si est√° en sesi√≥n (mejora para auditor√≠a)
                    if (CURRENT_USER_ID && CURRENT_USER_ID > 0) fd.append('aprobador_id', CURRENT_USER_ID);

                    const respRaw = await fetch('../php/coordinador_actions.php', { method: 'POST', body: fd });
                    const txt = await respRaw.text();
                    let resp;
                    try { resp = JSON.parse(txt); } catch (e) {
                        console.error('Respuesta inv√°lida del servidor:', txt);
                        mostrarRegistroFeedback('Respuesta inv√°lida del servidor. Revisa la consola.', false);
                        return;
                    }

                    console.log('validar_solicitud response', respRaw.status, resp);

                    if (respRaw.ok && resp && resp.success) {
                        mostrarRegistroFeedback('Solicitud procesada exitosamente.', true);
                        // actualizar vistas: pendientes + seguimiento
                        if (typeof cargarSolicitudes === 'function') cargarSolicitudes();
                        if (typeof cargarSeguimiento === 'function') cargarSeguimiento();
                        // cerrar modal al final
                        cerrarModalDetalle();
                    } else {
                        const detail = resp.detail || resp.detail_code || resp.message || 'Sin detalle';
                        mostrarRegistroFeedback('No se pudo procesar la solicitud: ' + detail, false);
                        // no cerrar modal para reintento
                    }
                } catch (err) {
                    console.error('Error al enviar validaci√≥n:', err);
                    mostrarRegistroFeedback('Error al conectar con el servidor.', false);
                }
            });
        }
    });
    </script>

    <!-- Chatbot widget -->
    <button class="chatbot-button" id="openChat">üí¨</button>
    <div class="chatbot-modal" id="chatModal" style="display:none;">
        <div class="chatbot-header">Asistente del portal</div>
        <div class="chatbot-body" id="chatBody">
            <div class="chatbot-msg bot"><span class="bubble">Hola, ¬ønecesitas ayuda con cursos o solicitudes?</span></div>
        </div>
        <div class="chatbot-input">
            <textarea id="chatInput" placeholder="Escribe tu pregunta..."></textarea>
            <button id="sendChat" style="background:#c41e3a;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">Enviar</button>
        </div>
    </div>

    <script>
    (function(){
        const openBtn = document.getElementById('openChat');
        const modal = document.getElementById('chatModal');
        const sendBtn = document.getElementById('sendChat');
        const input = document.getElementById('chatInput');
        const body = document.getElementById('chatBody');
        const endpoint = '../php/chatbot_api.php';

        openBtn.addEventListener('click', () => {
            modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
        });

        function appendMessage(from, text) {
            const div = document.createElement('div');
            div.className = 'chatbot-msg ' + (from === 'user' ? 'user' : 'bot');
            div.innerHTML = `<span class="bubble">${text}</span>`;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        sendBtn.addEventListener('click', () => {
            const q = input.value.trim();
            if (!q) return;
            const usuario_id = localStorage.getItem('currentUserId') || '';
            appendMessage('user', q);
            input.value = '';
            appendMessage('bot', 'Escribiendo...');

            fetch(endpoint, {
                method: 'POST',
                body: new URLSearchParams({ q: q, usuario_id: usuario_id })
            })
            .then(r => r.json())
            .then(res => {
                const typing = Array.from(body.querySelectorAll('.chatbot-msg.bot')).pop();
                if (typing && typing.textContent.trim() === 'Escribiendo...') typing.remove();

                if (res.success) {
                    appendMessage('bot', res.answer);
                    if (res.suggestions && Object.keys(res.suggestions).length) {
                        const keys = Object.keys(res.suggestions);
                        const linksHtml = keys.map(k => `<div class="chatbot-suggestion"><a href="${k}">${res.suggestions[k]}</a></div>`).join('');
                        const div = document.createElement('div');
                        div.className = 'chatbot-msg bot';
                        div.innerHTML = `<span class="bubble">${linksHtml}</span>`;
                        body.appendChild(div);
                        body.scrollTop = body.scrollHeight;
                    }
                } else {
                    appendMessage('bot', 'Lo siento, ocurri√≥ un error al procesar tu consulta.');
                }
            })
            .catch(() => {
                appendMessage('bot', 'Error de conexi√≥n. Intenta m√°s tarde.');
            });
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });
    })();
    </script>
</body>
</html>