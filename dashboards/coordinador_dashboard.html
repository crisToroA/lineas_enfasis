<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Académica - Universidad de Medellín</title>
    <link rel="stylesheet" href="../CSS/coordinador_dashboard.css">

</head>
<body>
    <!-- Header -->
    <div class="header">
        <img src="../IMG/logo.png" alt="Universidad de Medellín">
          <div class = "button">
            <button onclick="cerrarSesion()">Cerrar Sesión</button>
          </div>  
      </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Title -->
        <h1 class="page-title">
            Gestión Académica de Líneas de Énfasis
            <img src="https://previews.123rf.com/images/michaeljung/michaeljung0906/michaeljung090600290/5125275-teacher.jpg" alt="Icon" class="title-icon">
        </h1>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('registrar')">Registrar Curso</button>
            <button class="nav-tab" onclick="showSection('validar')">Validar Solicitudes</button>
            <button class="nav-tab" onclick="showSection('seguimiento')">Seguimiento Aprobaciones</button>
        </div>

        <!-- Registrar Curso Section -->
        <div id="registrar" class="content-section active">
            <div class="card">
                <h2 class="section-title">Registrar Nuevo Curso</h2>
                <form id="registroCursoForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre del Curso</label>
                            <input type="text" id="curso_nombre" name="nombre" placeholder="Ej: Cálculo Diferencial" required>
                        </div>
                        <div class="form-group">
                            <label>Código del Curso</label>
                            <input type="text" id="curso_codigo" name="codigo" placeholder="Ej: MAT101" required>
                        </div>
                        <div class="form-group">
                            <label>Semestre</label>
                            <select id="curso_semestre" name="semestre" required>
                                <option value="">Seleccione...</option>
                                <option>2024-1</option>
                                <option>2024-2</option>
                                <option>2025-1</option>
                            </select>
                        </div>

                        <!-- Nuevo: selector de profesor relacionado -->
                        <div class="form-group">
                            <label>Profesor responsable</label>
                            <select id="profesorSelect" name="profesor_id" required>
                                <option value="">Cargando profesores...</option>
                            </select>
                        </div>

                        <!-- Nuevo: selector de línea de énfasis -->
                        <div class="form-group">
                            <label>Línea de Énfasis</label>
                            <select id="lineaEnfasisSelect" name="linea_enfasis_id" required>
                                <option value="">Cargando líneas de énfasis...</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-submit">Registrar Curso</button>
                </form>
            </div>
            <!-- Nuevo: Filtro por línea de énfasis -->
            <div class="card" style="margin-top:30px;">
                <h2 class="section-title">Cursos Registrados</h2>
                <div style="margin-bottom:16px;">
                    <label for="filtroLineaEnfasis"><b>Filtrar por Línea de Énfasis:</b></label>
                    <select id="filtroLineaEnfasis">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="table-container">
                    <table id="tablaCursos">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Código</th>
                                <th>Semestre</th>
                                <th>Línea de Énfasis</th>
                                <th>Profesor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Se cargan dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Validar Solicitudes Section -->
        <div id="validar" class="content-section">
            <div class="card">
                <h2 class="section-title">Validación de Solicitudes</h2>
                <div class="table-container" id="solicitudesPendientes">
                    <table id="tablaSolicitudes" style="width:100%;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Remitente</th>
                                <th>Rol</th>
                                <th>Tipo</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Se carga dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Seguimiento Aprobaciones Section -->
        <div id="seguimiento" class="content-section">
            <div class="filter-group">
                <label>Filtrar por Semestre:</label>
                <select>
                    <option>2024-1</option>
                    <option>2024-2</option>
                    <option>2025-1</option>
                </select>
            </div>

            <div class="seguimiento-container">
                <!-- Lista de Solicitudes -->
                <div class="solicitudes-list">
                    <h2 class="section-title">Listado de Solicitudes</h2>
                    
                    
                </div>


                

    <script>
        function showSection(sectionId) {
            // Hide all sections
            var sections = document.querySelectorAll('.content-section');
            sections.forEach(function(section) {
                section.classList.remove('active');
            });

            // Remove active class from all tabs
            var tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Función para registrar curso
        document.getElementById('registroCursoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const nombre = document.getElementById('curso_nombre').value.trim();
            const codigo = document.getElementById('curso_codigo').value.trim();
            const semestre = document.getElementById('curso_semestre').value;
            const profesor_id = document.getElementById('profesorSelect').value;
            const linea_enfasis_id = document.getElementById('lineaEnfasisSelect').value;

            if (!nombre || !codigo || !semestre || !profesor_id || !linea_enfasis_id) {
                alert('Complete todos los campos del formulario.');
                return;
            }

            const formData = new FormData();
            formData.append('action', 'registrar_curso');
            formData.append('nombre', nombre);
            formData.append('codigo', codigo);
            formData.append('semestre', semestre);
            formData.append('profesor_id', profesor_id);
            formData.append('linea_enfasis_id', linea_enfasis_id);

            fetch('../php/coordinador_actions.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    alert('Curso registrado correctamente.');
                    this.reset();
                    cargarCursos(); // <--- recarga la tabla
                } else {
                    alert('Error: ' + (resp.message || 'No fue posible registrar el curso.'));
                }
            })
            .catch(err => {
                console.error('Error registrar curso', err);
                alert('Error al conectar con el servidor.');
            });
        });

        // Cargar solicitudes en tabla
        function cargarSolicitudes() {
            fetch('../php/coordinador_actions.php?action=obtener_solicitudes')
            .then(response => response.json())
            .then(solicitudes => {
                const tbody = document.querySelector('#tablaSolicitudes tbody');
                if (!Array.isArray(solicitudes) || solicitudes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">No hay solicitudes registradas.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                solicitudes.forEach(solicitud => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${solicitud.id}</td>
                        <td>${solicitud.remitente}</td>
                        <td>${solicitud.rol}</td>
                        <td>${solicitud.tipo}</td>
                        <td>${solicitud.fecha}</td>
                        <td>
                            <span class="status-badge status-${solicitud.estado}">${solicitud.estado.charAt(0).toUpperCase() + solicitud.estado.slice(1)}</span>
                        </td>
                        <td>
                            <button class="btn-action" style="padding:4px 12px;" onclick="verDetalleSolicitud(${solicitud.id})">Ver</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(() => {
                document.querySelector('#tablaSolicitudes tbody').innerHTML = '<tr><td colspan="7">Error al cargar las solicitudes.</td></tr>';
            });
        }

        // Mostrar modal con detalle de solicitud
    function verDetalleSolicitud(id) {
        fetch(`../php/coordinador_actions.php?action=detalle_solicitud&id=${id}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('detalleTipo').textContent = data.tipo;
            document.getElementById('detalleRemitente').textContent = data.remitente;
            document.getElementById('detalleRol').textContent = data.rol;
            document.getElementById('detalleFecha').textContent = data.fecha;
            document.getElementById('detalleEstado').textContent = data.estado.charAt(0).toUpperCase() + data.estado.slice(1);
            document.getElementById('detalleDescripcion').textContent = data.descripcion || '(Sin detalles)';
            document.getElementById('modalDetalleSolicitud').style.display = 'flex';

            // Mostrar/ocultar botones según estado
            if (data.estado === 'pendiente') {
                document.getElementById('detalleAcciones').style.display = 'flex';
                document.getElementById('btnAprobar').onclick = function() { procesarSolicitud(data.id, 'aprobada'); };
                document.getElementById('btnRechazar').onclick = function() { procesarSolicitud(data.id, 'rechazada'); };
            } else {
                document.getElementById('detalleAcciones').style.display = 'none';
            }
        });
    }

    function cerrarModalDetalle() {
        document.getElementById('modalDetalleSolicitud').style.display = 'none';
    }

    // Procesar solicitud (aprobar/rechazar)
    function procesarSolicitud(id, estado) {
        const formData = new FormData();
        formData.append('action', 'validar_solicitud');
        formData.append('solicitud_id', id);
        formData.append('estado', estado);

        fetch('../php/coordinador_actions.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                alert('Solicitud procesada exitosamente');
                cerrarModalDetalle();
                cargarSolicitudes();
            }
        });
    }

        // Cerrar sesión
        function cerrarSesion() {
            fetch('../api/logout.php')
            .then(() => {
                window.location.href = '../index.html';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cerrar sesión');
            });
        }

        // Cargar lista de profesores desde el servidor
		function cargarProfesores() {
			const select = document.getElementById('profesorSelect');
			select.innerHTML = '<option value="">Cargando profesores...</option>';

			fetch('../php/coordinador_actions.php?action=list_profesores')
			.then(res => res.json())
			.then(data => {
				if (!Array.isArray(data)) {
					select.innerHTML = '<option value="">No se encontraron profesores</option>';
					return;
				}
				select.innerHTML = '<option value="">Seleccione un profesor</option>';
				data.forEach(prof => {
					const opt = document.createElement('option');
					opt.value = prof.id;
					opt.textContent = prof.nombre + ' (' + prof.documento + ')';
					select.appendChild(opt);
				});
			})
			.catch(err => {
				console.error('Error cargando profesores', err);
				select.innerHTML = '<option value="">Error al cargar profesores</option>';
			});
		}

        // Cargar líneas de énfasis en ambos selects
        function cargarLineasEnfasis() {
            fetch('../php/coordinador_actions.php?action=list_lineas_enfasis')
            .then(res => res.json())
            .then(data => {
                // Para el formulario de registro
                const selectForm = document.getElementById('lineaEnfasisSelect');
                selectForm.innerHTML = '<option value="">Seleccione una línea de énfasis</option>';
                data.forEach(le => {
                    const opt = document.createElement('option');
                    opt.value = le.id;
                    opt.textContent = le.nombre;
                    selectForm.appendChild(opt);
                });
                // Para el filtro
                const selectFiltro = document.getElementById('filtroLineaEnfasis');
                selectFiltro.innerHTML = '<option value="">Todas</option>';
                data.forEach(le => {
                    const opt = document.createElement('option');
                    opt.value = le.id;
                    opt.textContent = le.nombre;
                    selectFiltro.appendChild(opt);
                });
            });
        }

        // Cargar cursos registrados with filter
        function cargarCursos() {
            const filtroLinea = document.getElementById('filtroLineaEnfasis').value;
            let url = '../php/coordinador_actions.php?action=list_cursos';
            if (filtroLinea) url += '&linea_enfasis_id=' + encodeURIComponent(filtroLinea);

            fetch(url)
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector('#tablaCursos tbody');
                if (!Array.isArray(data) || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No hay cursos registrados.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                data.forEach(curso => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${curso.nombre}</td>
                        <td>${curso.codigo}</td>
                        <td>${curso.semestre}</td>
                        <td>${curso.linea_enfasis_nombre}</td>
                        <td>${curso.profesor_nombre}</td>
                        <td>
                            <button onclick="eliminarCurso(${curso.id})" class="btn-action btn-rechazar" style="padding:4px 12px;">Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        // Eliminar curso
        function eliminarCurso(id) {
            if (!confirm('¿Seguro que deseas eliminar este curso?')) return;
            const formData = new FormData();
            formData.append('action', 'eliminar_curso');
            formData.append('curso_id', id);

            fetch('../php/coordinador_actions.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    alert('Curso eliminado.');
                    cargarCursos();
                } else {
                    alert('No se pudo eliminar el curso.');
                }
            });
        }

        // Recargar cursos al cambiar filtro
        document.getElementById('filtroLineaEnfasis').addEventListener('change', cargarCursos);

        // Cargar solicitudes, profesores y líneas de énfasis al iniciar
		cargarSolicitudes();
		cargarProfesores();
        cargarLineasEnfasis();
        cargarCursos();
    </script>
</body>
</html>