<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Académica - Universidad de Medellín</title>
    <link rel="stylesheet" href="../CSS/coordinador_dashboard.css">

</head>
<body>
    <!-- Header -->
    <div class="header">
        <img src="../IMG/logo.png" alt="Universidad de Medellín">
          <div class = "button">
            <button onclick="cerrarSesion()">Cerrar Sesión</button>
          </div>  
      </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Title -->
        <h1 class="page-title">
            Gestión Académica de Líneas de Énfasis
            <img src="https://previews.123rf.com/images/michaeljung/michaeljung0906/michaeljung090600290/5125275-teacher.jpg" alt="Icon" class="title-icon">
        </h1>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('registrar')">Registrar Curso</button>
            <button class="nav-tab" onclick="showSection('validar')">Validar Solicitudes</button>
            <button class="nav-tab" onclick="showSection('seguimiento')">Seguimiento Aprobaciones</button>
        </div>

        <!-- Registrar Curso Section -->
        <div id="registrar" class="content-section active">
            <div class="card">
                <h2 class="section-title">Registrar Nuevo Curso</h2>
                <form id="registroCursoForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre del Curso</label>
                            <input type="text" id="curso_nombre" name="nombre" placeholder="Ej: Cálculo Diferencial" required>
                        </div>
                        <div class="form-group">
                            <label>Código del Curso</label>
                            <input type="text" id="curso_codigo" name="codigo" placeholder="Ej: MAT101" required>
                        </div>
                        <div class="form-group">
                            <label>Semestre</label>
                            <select id="curso_semestre" name="semestre" required>
                                <option value="">Seleccione...</option>
                                <option>2024-1</option>
                                <option>2024-2</option>
                                <option>2025-1</option>
                            </select>
                        </div>

                        <!-- Nuevo: selector de profesor relacionado -->
                        <div class="form-group">
                            <label>Profesor responsable</label>
                            <select id="profesorSelect" name="profesor_id" required>
                                <option value="">Cargando profesores...</option>
                            </select>
                        </div>

                        <!-- Nuevo: selector de línea de énfasis -->
                        <div class="form-group">
                            <label>Línea de Énfasis</label>
                            <select id="lineaEnfasisSelect" name="linea_enfasis_id" required>
                                <option value="">Cargando líneas de énfasis...</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-submit">Registrar Curso</button>
                </form>
            </div>
            <!-- Nuevo: Filtro por línea de énfasis -->
            <div class="card" style="margin-top:30px;">
                <h2 class="section-title">Cursos Registrados</h2>
                <div style="margin-bottom:16px;">
                    <label for="filtroLineaEnfasis"><b>Filtrar por Línea de Énfasis:</b></label>
                    <select id="filtroLineaEnfasis">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="table-container">
                    <table id="tablaCursos">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Código</th>
                                <th>Semestre</th>
                                <th>Línea de Énfasis</th>
                                <th>Profesor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Se cargan dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Validar Solicitudes Section -->
        <div id="validar" class="content-section">
            <div class="card">
                <h2 class="section-title">Validación de Solicitudes</h2>
                <div class="table-container" id="solicitudesPendientes">
                    <table id="tablaSolicitudes" style="width:100%;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Remitente</th>
                                <th>Rol</th>
                                <th>Tipo</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Se carga dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Seguimiento Aprobaciones Section -->
        <div id="seguimiento" class="content-section">
		<div class="filter-group">
			<label>Filtrar por Semestre:</label>
			<select>
				<option>2024-1</option>
				<option>2024-2</option>
				<option>2025-1</option>
			</select>
		</div>

		<div class="seguimiento-container">
			<!-- Lista de Solicitudes procesadas -->
			<div class="solicitudes-list">
				<h2 class="section-title">Listado de Solicitudes (Aprobadas / Rechazadas)</h2>
				<div id="listaSeguimiento">
					<!-- Se llenará dinámicamente -->
				</div>
			</div>

			<!-- Panel detalle (visor de una solicitud seleccionada) -->
			<div class="detalles-panel" id="panelDetalleSeguimiento">
				<h2 class="section-title">Detalle</h2>
				<div id="detalleContent">
					<p><b>Tipo:</b> <span id="detalleTipo">-</span></p>
					<p><b>Remitente:</b> <span id="detalleRemitente">-</span></p>
					<p><b>Rol:</b> <span id="detalleRol">-</span></p>
					<p><b>Fecha envío:</b> <span id="detalleFecha">-</span></p>
					<p><b>Estado:</b> <span id="detalleEstado">-</span></p>
					<p><b>Descripción (remitente):</b></p>
					<p id="detalleDescripcion">-</p>
					<p><b>Comentario del coordinador:</b></p>
					<p id="detalleComentarioCoordinador">-</p>
					<p><b>Aprobado por:</b> <span id="detalleAprobador">-</span></p>
					<p><b>Fecha de procesado:</b> <span id="detalleFechaProcesamiento">-</span></p>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal detalle / validación -->
	<div id="modalDetalleSolicitud" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;">
		<div style="background:white;border-radius:8px;padding:20px;max-width:800px;width:95%;max-height:90vh;overflow:auto;position:relative;">
			<button onclick="cerrarModalDetalle()" style="position:absolute;right:12px;top:12px;background:#eee;border:none;padding:8px;border-radius:6px;cursor:pointer;">Cerrar</button>
			<h3>Detalle de Solicitud</h3>
			<p><b>Tipo:</b> <span id="detalleTipo">-</span></p>
			<p><b>Remitente:</b> <span id="detalleRemitente">-</span></p>
			<p><b>Rol:</b> <span id="detalleRol">-</span></p>
			<p><b>Fecha envío:</b> <span id="detalleFecha">-</span></p>
			<p><b>Estado:</b> <span id="detalleEstado">-</span></p>
			<p><b>Descripción (remitente):</b></p>
			<p id="detalleDescripcion">-</p>

			<!-- Comentario del coordinador (si ya hay) -->
			<div id="detalleComentarioExistente" style="margin-top:10px;display:none;">
				<p><b>Comentario del coordinador:</b></p>
				<p id="detalleComentarioCoordinador">-</p>
			</div>

			<!-- Área para dejar comentario al procesar (solo cuando está pendiente) -->
			<div id="detalleAcciones" style="margin-top:16px;display:none;">
				<label for="coordinatorComment"><b>Comentario para el remitente (requerido)</b></label>
				<textarea id="coordinatorComment" style="width:100%;min-height:100px;padding:8px;margin-top:8px;border:1px solid #ddd;border-radius:6px;"></textarea>
				<div style="display:flex;gap:10px;margin-top:12px;">
					<button id="btnAprobar" class="btn-action btn-aprobar" style="padding:8px 16px;">Aprobar</button>
					<button id="btnRechazar" class="btn-action btn-rechazar" style="padding:8px 16px;">Rechazar</button>
				</div>
			</div>
		</div>
	</div>

    <script>
        function showSection(sectionId) {
            // Hide all sections
            var sections = document.querySelectorAll('.content-section');
            sections.forEach(function(section) {
                section.classList.remove('active');
            });

            // Remove active class from all tabs
            var tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Función para registrar curso
        document.getElementById('registroCursoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const nombre = document.getElementById('curso_nombre').value.trim();
            const codigo = document.getElementById('curso_codigo').value.trim();
            const semestre = document.getElementById('curso_semestre').value;
            const profesor_id = document.getElementById('profesorSelect').value;
            const linea_enfasis_id = document.getElementById('lineaEnfasisSelect').value;

            if (!nombre || !codigo || !semestre || !profesor_id || !linea_enfasis_id) {
                alert('Complete todos los campos del formulario.');
                return;
            }

            const formData = new FormData();
            formData.append('action', 'registrar_curso');
            formData.append('nombre', nombre);
            formData.append('codigo', codigo);
            formData.append('semestre', semestre);
            formData.append('profesor_id', profesor_id);
            formData.append('linea_enfasis_id', linea_enfasis_id);

            fetch('../php/coordinador_actions.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    alert('Curso registrado correctamente.');
                    this.reset();
                    cargarCursos(); // <--- recarga la tabla
                } else {
                    alert('Error: ' + (resp.message || 'No fue posible registrar el curso.'));
                }
            })
            .catch(err => {
                console.error('Error registrar curso', err);
                alert('Error al conectar con el servidor.');
            });
        });

        // Cargar solicitudes en tabla
        function cargarSolicitudes() {
            fetch('../php/coordinador_actions.php?action=obtener_solicitudes')
            .then(response => response.json())
            .then(solicitudes => {
                const tbody = document.querySelector('#tablaSolicitudes tbody');
                if (!Array.isArray(solicitudes) || solicitudes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">No hay solicitudes registradas.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                solicitudes.forEach(solicitud => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${solicitud.id}</td>
                        <td>${solicitud.remitente}</td>
                        <td>${solicitud.rol}</td>
                        <td>${solicitud.tipo}</td>
                        <td>${solicitud.fecha}</td>
                        <td>
                            <span class="status-badge status-${solicitud.estado}">${solicitud.estado.charAt(0).toUpperCase() + solicitud.estado.slice(1)}</span>
                        </td>
                        <td>
                            <button class="btn-action" style="padding:4px 12px;" onclick="verDetalleSolicitud(${solicitud.id})">Ver</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(() => {
                document.querySelector('#tablaSolicitudes tbody').innerHTML = '<tr><td colspan="7">Error al cargar las solicitudes.</td></tr>';
            });
        }

        // Mostrar modal con detalle de solicitud
    function verDetalleSolicitud(id) {
        fetch(`../php/coordinador_actions.php?action=detalle_solicitud&id=${id}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('detalleTipo').textContent = data.tipo || '-';
            document.getElementById('detalleRemitente').textContent = data.remitente || '-';
            document.getElementById('detalleRol').textContent = data.rol || '-';
            document.getElementById('detalleFecha').textContent = data.fecha || '-';
            document.getElementById('detalleEstado').textContent = (data.estado ? data.estado.charAt(0).toUpperCase() + data.estado.slice(1) : '-');
            document.getElementById('detalleDescripcion').textContent = data.descripcion || '(Sin detalles)';

            // Comentario del coordinador (si existe)
            if (data.comentario_coordinador && data.comentario_coordinador.trim() !== '') {
                document.getElementById('detalleComentarioExistente').style.display = 'block';
                document.getElementById('detalleComentarioCoordinador').textContent = data.comentario_coordinador;
            } else {
                document.getElementById('detalleComentarioExistente').style.display = 'none';
                document.getElementById('detalleComentarioCoordinador').textContent = '-';
            }

            // Mostrar/ocultar botones según estado
            if (data.estado === 'pendiente') {
                document.getElementById('detalleAcciones').style.display = 'block';
                document.getElementById('coordinatorComment').value = '';
                document.getElementById('btnAprobar').onclick = function() { procesarSolicitud(data.id, 'aprobada'); };
                document.getElementById('btnRechazar').onclick = function() { procesarSolicitud(data.id, 'rechazada'); };
            } else {
                document.getElementById('detalleAcciones').style.display = 'none';
            }

            // Mostrar modal y limpiar posibles campos
            document.getElementById('modalDetalleSolicitud').style.display = 'flex';
        });
    }

    function cerrarModalDetalle() {
        document.getElementById('modalDetalleSolicitud').style.display = 'none';
    }

    // Procesar solicitud (aprobar/rechazar) con comentario
    function procesarSolicitud(id, estado) {
        const comentario = document.getElementById('coordinatorComment').value.trim();
        if (!comentario) {
            alert('Por favor deje un comentario antes de procesar la solicitud.');
            return;
        }
        const formData = new FormData();
        formData.append('action', 'validar_solicitud');
        formData.append('solicitud_id', id);
        formData.append('estado', estado);
        formData.append('comentario', comentario);
        // Si se dispone de id de coordinador en frontend, se puede anexar:
        // formData.append('aprobador_id', 123);

        fetch('../php/coordinador_actions.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                alert('Solicitud procesada exitosamente');
                cerrarModalDetalle();
                cargarSolicitudes();
                cargarSeguimiento(); // actualizar seguimiento
            } else {
                alert('Error al procesar la solicitud');
            }
        })
        .catch(err => {
            console.error('Error validar solicitud', err);
            alert('Error al conectar con el servidor.');
        });
    }

    // Cargar seguimiento (solicitudes aprobadas/rechazadas)
		function cargarSeguimiento() {
			fetch('../php/coordinador_actions.php?action=list_solicitudes_procesadas')
			.then(res => res.json())
			.then(data => {
				const cont = document.getElementById('listaSeguimiento');
				if (!Array.isArray(data) || data.length === 0) {
					cont.innerHTML = '<p>No hay solicitudes procesadas.</p>';
					return;
				}
				cont.innerHTML = '';
				data.forEach(s => {
					const div = document.createElement('div');
					div.className = 'historial-item';
					div.style.marginBottom = '12px';
					div.innerHTML = `
						<div style="display:flex;justify-content:space-between;align-items:center;">
							<div>
								<b>(${s.estado.toUpperCase()})</b> ${s.tipo} — <span style="color:#666">${s.remitente}</span>
								<div style="font-size:13px;color:#999;margin-top:6px;">Enviado: ${s.fecha} • Procesado: ${s.fecha_procesamiento || '-'}</div>
							</div>
							<div style="text-align:right;">
								<div style="font-size:13px;color:#333;">${s.aprobador_nombre ? s.aprobador_nombre : '—'}</div>
								<button class="btn-action" style="margin-top:8px;padding:6px 10px;" onclick="verDetalleSolicitud(${s.id})">Ver</button>
							</div>
						</div>
						<div style="margin-top:8px;">
							<p style="margin:0;"><b>Descripción (remitente):</b></p>
							<p style="margin:0;color:#444;">${s.descripcion || '(Sin descripción)'}</p>
							<div style="margin-top:8px;">
								<p style="margin:0;"><b>Comentario del coordinador:</b></p>
								<p style="margin:0;color:#444;">${s.comentario_coordinador || '(Sin comentario)'}</p>
							</div>
						</div>
					`;
					cont.appendChild(div);
				});
			})
			.catch(err => {
				console.error('Error cargar seguimiento', err);
				document.getElementById('listaSeguimiento').innerHTML = '<p>Error al cargar seguimiento.</p>';
			});
		}

        // Cerrar sesión
        function cerrarSesion() {
            fetch('../api/logout.php')
            .then(() => {
                window.location.href = '../index.html';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cerrar sesión');
            });
        }

        // Cargar lista de profesores desde el servidor
		function cargarProfesores() {
			const select = document.getElementById('profesorSelect');
			select.innerHTML = '<option value="">Cargando profesores...</option>';

			fetch('../php/coordinador_actions.php?action=list_profesores')
			.then(res => res.json())
			.then(data => {
				if (!Array.isArray(data)) {
					select.innerHTML = '<option value="">No se encontraron profesores</option>';
					return;
				}
				select.innerHTML = '<option value="">Seleccione un profesor</option>';
				data.forEach(prof => {
					const opt = document.createElement('option');
					opt.value = prof.id;
					opt.textContent = prof.nombre + ' (' + prof.documento + ')';
					select.appendChild(opt);
				});
			})
			.catch(err => {
				console.error('Error cargando profesores', err);
				select.innerHTML = '<option value="">Error al cargar profesores</option>';
			});
		}

        // Cargar líneas de énfasis en ambos selects
        function cargarLineasEnfasis() {
            fetch('../php/coordinador_actions.php?action=list_lineas_enfasis')
            .then(res => res.json())
            .then(data => {
                // Para el formulario de registro
                const selectForm = document.getElementById('lineaEnfasisSelect');
                selectForm.innerHTML = '<option value="">Seleccione una línea de énfasis</option>';
                data.forEach(le => {
                    const opt = document.createElement('option');
                    opt.value = le.id;
                    opt.textContent = le.nombre;
                    selectForm.appendChild(opt);
                });
                // Para el filtro
                const selectFiltro = document.getElementById('filtroLineaEnfasis');
                selectFiltro.innerHTML = '<option value="">Todas</option>';
                data.forEach(le => {
                    const opt = document.createElement('option');
                    opt.value = le.id;
                    opt.textContent = le.nombre;
                    selectFiltro.appendChild(opt);
                });
            });
        }

        // Cargar cursos registrados with filter
        function cargarCursos() {
            const filtroLinea = document.getElementById('filtroLineaEnfasis').value;
            let url = '../php/coordinador_actions.php?action=list_cursos';
            if (filtroLinea) url += '&linea_enfasis_id=' + encodeURIComponent(filtroLinea);

            fetch(url)
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector('#tablaCursos tbody');
                if (!Array.isArray(data) || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No hay cursos registrados.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                data.forEach(curso => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${curso.nombre}</td>
                        <td>${curso.codigo}</td>
                        <td>${curso.semestre}</td>
                        <td>${curso.linea_enfasis_nombre}</td>
                        <td>${curso.profesor_nombre}</td>
                        <td>
                            <button onclick="eliminarCurso(${curso.id})" class="btn-action btn-rechazar" style="padding:4px 12px;">Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        // Eliminar curso
        function eliminarCurso(id) {
            if (!confirm('¿Seguro que deseas eliminar este curso?')) return;
            const formData = new FormData();
            formData.append('action', 'eliminar_curso');
            formData.append('curso_id', id);

            fetch('../php/coordinador_actions.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    alert('Curso eliminado.');
                    cargarCursos();
                } else {
                    alert('No se pudo eliminar el curso.');
                }
            });
        }

        // Recargar cursos al cambiar filtro
        document.getElementById('filtroLineaEnfasis').addEventListener('change', cargarCursos);

        // Cargar solicitudes, profesores y líneas de énfasis al iniciar
		cargarSolicitudes();
		cargarProfesores();
        cargarLineasEnfasis();
        cargarCursos();
        cargarSeguimiento();
    </script>
</body>
</html>