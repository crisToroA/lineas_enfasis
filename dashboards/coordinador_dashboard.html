<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Acad√©mica - Universidad de Medell√≠n</title>
    <link rel="stylesheet" href="../CSS/coordinador_dashboard.css">
    <link rel="stylesheet" href="../CSS/chatbot.css">

</head>
<body>
    <!-- Header -->
    <div class="header">
        <img src="../IMG/logo.png" alt="Universidad de Medell√≠n">
          <div class = "button">
            <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
          </div>  
      </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Title -->
        <h1 class="page-title">
            Gesti√≥n Acad√©mica de L√≠neas de √ânfasis
            <img src="https://previews.123rf.com/images/michaeljung/michaeljung0906/michaeljung090600290/5125275-teacher.jpg" alt="Icon" class="title-icon">
        </h1>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('registrar')">Registrar Curso</button>
            <button class="nav-tab" onclick="showSection('validar')">Validar Solicitudes</button>
            <button class="nav-tab" onclick="showSection('seguimiento')">Seguimiento Aprobaciones</button>
        </div>

        <!-- Registrar Curso Section -->
        <div id="registrar" class="content-section active">
            <!-- Reemplazado: tarjeta de registro con dise√±o mejorado -->
            <div class="card card--elevated">
                <div class="card-header">
                    <h2 class="section-title">Registrar Nuevo Curso</h2>
                    <p class="card-subtitle">Complete la informaci√≥n del curso. El comentario del profesor es opcional.</p>
                </div>

                <form id="registroCursoForm" class="registro-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label><span class="label-icon">üìò</span> Nombre del Curso</label>
                            <input type="text" id="curso_nombre" name="nombre" placeholder="Ej: C√°lculo Diferencial" required>
                            <div class="helper-text">Nombre descriptivo y claro (m√°x. 150 caracteres).</div>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üîñ</span> C√≥digo del Curso</label>
                            <input type="text" id="curso_codigo" name="codigo" placeholder="Ej: MAT101" required>
                            <div class="helper-text">C√≥digo √∫nico (sin espacios).</div>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üìÖ</span> Semestre</label>
                            <select id="curso_semestre" name="semestre" required>
                                <option value="">Seleccione...</option>
                                <option>2024-1</option>
                                <option>2024-2</option>
                                <option>2025-1</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üë©‚Äçüè´</span> Profesor responsable</label>
                            <select id="profesorSelect" name="profesor_id" required>
                                <option value="">Cargando profesores...</option>
                            </select>
                            <div class="helper-text">Seleccione el docente que dictar√° el curso.</div>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üìö</span> L√≠nea de √ânfasis</label>
                            <select id="lineaEnfasisSelect" name="linea_enfasis_id" required>
                                <option value="">Cargando l√≠neas de √©nfasis...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üìù</span> Notas/Observaciones (opcional)</label>
                            <input type="text" id="curso_observaciones" name="observaciones" placeholder="Ej: Requiere laboratorio complementario">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-submit">Registrar Curso</button>
                        <div id="registroFeedback" class="feedback" aria-live="polite" style="display:none;"></div>
                    </div>
                </form>
            </div>
            <!-- Nuevo: Filtro por l√≠nea de √©nfasis + lista de cursos (tarjetas) -->
            <div class="card" style="margin-top:30px;">
                <div class="card-header" style="display:flex;flex-direction:column;gap:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
                        <h2 class="section-title" style="margin:0;">Cursos Registrados</h2>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input id="buscarCurso" type="text" placeholder="Buscar por nombre o c√≥digo..." style="padding:10px 12px;border-radius:8px;border:1px solid #e6e6e6;width:260px;">
                            <label for="filtroLineaEnfasis" style="margin:0 6px 0 0;font-weight:600;color:#333;">L√≠nea:</label>
                            <select id="filtroLineaEnfasis" style="padding:10px;border-radius:8px;border:1px solid #e6e6e6;">
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <p class="card-subtitle" style="margin:0;color:#666;font-size:13px;">Busca, filtra y administra los cursos registrados. Haz click en eliminar para borrarlo.</p>
                </div>

                <div id="listaCursos" class="courses-grid" style="margin-top:18px;">
                    <!-- Se generan tarjetas de curso din√°micamente -->
                </div>

                <!-- Tabla de respaldo (oculta) para compatibilidad -->
                <div class="table-container" style="display:none;">
                    <table id="tablaCursos">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>C√≥digo</th>
                                <th>Semestre</th>
                                <th>L√≠nea de √ânfasis</th>
                                <th>Profesor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Se cargan din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Validar Solicitudes Section -->
        <div id="validar" class="content-section">
            <div class="card">
                <h2 class="section-title">Validaci√≥n de Solicitudes</h2>
                <div class="table-container" id="solicitudesPendientes">
                    <table id="tablaSolicitudes" style="width:100%;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Remitente</th>
                                <th>Rol</th>
                                <th>Tipo</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Se carga din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Seguimiento Aprobaciones Section -->
        <div id="seguimiento" class="content-section">
			<div class="filter-group">
				<label>Filtrar por Semestre:</label>
				<select>
					<option>2024-1</option>
					<option>2024-2</option>
					<option>2025-1</option>
				</select>
			</div>

			<div class="seguimiento-container">
				<!-- Lista de Solicitudes procesadas -->
				<div class="solicitudes-list" id="contSolicitudesProcesadas">
					<h2 class="section-title">Listado de Solicitudes (Aprobadas / Rechazadas)</h2>
					<div id="listaSeguimiento">
						<!-- Se llenar√° din√°micamente -->
					</div>
				</div>

				<!-- Panel detalle (ahora lateral y oculto por defecto) -->
				<div class="detalles-panel" id="panelDetalleSeguimiento">
					<button class="detalle-close" id="cerrarPanelDetalle">‚Üê Volver</button>
					<h2 class="section-title" style="margin-top:0;">Detalle</h2>

					<div id="detalleContentPanel">
						<p><b>Tipo:</b> <span id="detalleTipoPanel">-</span></p>
						<p><b>Remitente:</b> <span id="detalleRemitentePanel">-</span></p>
						<p><b>Rol:</b> <span id="detalleRolPanel">-</span></p>
						<p><b>Fecha env√≠o:</b> <span id="detalleFechaPanel">-</span></p>
						<p><b>Estado:</b> <span id="detalleEstadoPanel">-</span></p>
						<p><b>Descripci√≥n (remitente):</b></p>
						<p id="detalleDescripcionPanel">-</p>

						<p><b>Comentario del coordinador:</b></p>
						<p id="detalleComentarioCoordinadorPanel">-</p>

						<p><b>Aprobado por:</b> <span id="detalleAprobadorPanel">-</span></p>
						<p><b>Fecha de procesado:</b> <span id="detalleFechaProcesamientoPanel">-</span></p>
					</div>
				</div>
			</div>
		</div>

	<!-- Modal detalle / validaci√≥n (reemplazado por versi√≥n con vistas) -->
	<div id="modalDetalleSolicitud" class="modal-overlay" style="display:none;">
		<div class="modal-card">
			<div class="modal-header">
				<button id="modalBack" class="modal-back" title="Volver" style="display:none;">‚Üê</button>
				<h3 id="modalTitle" style="margin:0;">Detalle de Solicitud</h3>
				<button onclick="cerrarModalDetalle()" class="modal-close" title="Cerrar">‚úï</button>
			</div>

			<!-- Vista: Detalles -->
			<div id="modalDetails" class="modal-body">
				<p><b>Tipo:</b> <span id="detalleTipo">-</span></p>
				<p><b>Remitente:</b> <span id="detalleRemitente">-</span></p>
				<p><b>Rol:</b> <span id="detalleRol">-</span></p>
				<p><b>Fecha env√≠o:</b> <span id="detalleFecha">-</span></p>
				<p><b>Estado:</b> <span id="detalleEstado">-</span></p>
				<p><b>Descripci√≥n (remitente):</b></p>
				<p id="detalleDescripcion">-</p>

				<div id="detalleComentarioExistente" style="margin-top:10px;display:none;">
					<p><b>Comentario del coordinador:</b></p>
					<p id="detalleComentarioCoordinador">-</p>
				</div>

				<div style="display:flex;gap:12px;margin-top:16px;">
					<button id="btnAprobar" class="btn-action btn-aprobar">Aprobar</button>
					<button id="btnRechazar" class="btn-action btn-rechazar">Rechazar</button>
				</div>
			</div>

			<!-- Vista: Acci√≥n (comentar y enviar) -->
			<div id="modalAction" class="modal-body" style="display:none;">
				<p style="margin-top:0;"><b>Acci√≥n:</b> <span id="accionTipo">-</span></p>
				<label for="actionComment"><b>Comentario obligatorio:</b></label>
				<textarea id="actionComment" style="width:100%;min-height:140px;padding:8px;margin-top:8px;border:1px solid #ddd;border-radius:6px;"></textarea>

				<div style="display:flex;gap:12px;margin-top:12px;">
					<button id="submitActionBtn" class="btn-action btn-aprobar action-submit">Enviar y Aprobar</button>
					<button id="cancelActionBtn" class="btn-action btn-rechazar action-cancel">Cancelar</button>
				</div>
			</div>
		</div>
	</div>

    <script>
        function showSection(sectionId) {
            // Hide all sections
            var sections = document.querySelectorAll('.content-section');
            sections.forEach(function(section) {
                section.classList.remove('active');
            });

            // Remove active class from all tabs
            var tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Funci√≥n para registrar curso
        document.getElementById('registroCursoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const nombre = document.getElementById('curso_nombre').value.trim();
            const codigo = document.getElementById('curso_codigo').value.trim();
            const semestre = document.getElementById('curso_semestre').value;
            const profesor_id = document.getElementById('profesorSelect').value;
            const linea_enfasis_id = document.getElementById('lineaEnfasisSelect').value;

            if (!nombre || !codigo || !semestre || !profesor_id || !linea_enfasis_id) {
                alert('Complete todos los campos del formulario.');
                return;
            }

            const formData = new FormData();
            formData.append('action', 'registrar_curso');
            formData.append('nombre', nombre);
            formData.append('codigo', codigo);
            formData.append('semestre', semestre);
            formData.append('profesor_id', profesor_id);
            formData.append('linea_enfasis_id', linea_enfasis_id);

            fetch('../php/coordinador_actions.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    alert('Curso registrado correctamente.');
                    this.reset();
                    cargarCursos(); // <--- recarga la tabla
                } else {
                    alert('Error: ' + (resp.message || 'No fue posible registrar el curso.'));
                }
            })
            .catch(err => {
                console.error('Error registrar curso', err);
                alert('Error al conectar con el servidor.');
            });
        });

        // Cargar solicitudes en tabla
        function cargarSolicitudes() {
            fetch('../php/coordinador_actions.php?action=obtener_solicitudes')
            .then(response => response.json())
            .then(solicitudes => {
                const tbody = document.querySelector('#tablaSolicitudes tbody');
                if (!Array.isArray(solicitudes) || solicitudes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">No hay solicitudes registradas.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                solicitudes.forEach(solicitud => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${solicitud.id}</td>
                        <td>${solicitud.remitente}</td>
                        <td>${solicitud.rol}</td>
                        <td>${solicitud.tipo}</td>
                        <td>${solicitud.fecha}</td>
                        <td>
                            <span class="status-badge status-${solicitud.estado}">${solicitud.estado.charAt(0).toUpperCase() + solicitud.estado.slice(1)}</span>
                        </td>
                        <td>
                            <button class="btn-action" style="padding:4px 12px;" onclick="verDetalleSolicitud(${solicitud.id})">Ver</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(() => {
                document.querySelector('#tablaSolicitudes tbody').innerHTML = '<tr><td colspan="7">Error al cargar las solicitudes.</td></tr>';
            });
        }

        // Mostrar modal con detalle de solicitud (actualizado)
    function verDetalleSolicitud(id) {
        fetch(`../php/coordinador_actions.php?action=detalle_solicitud&id=${id}`)
        .then(res => res.json())
        .then(data => {
            _currentSolicitudId = data.id ?? id;
            _currentAccion = null;
            // Llenar campos de detalle
            document.getElementById('detalleTipo').textContent = data.tipo || '-';
            document.getElementById('detalleRemitente').textContent = data.remitente || '-';
            document.getElementById('detalleRol').textContent = data.rol || '-';
            document.getElementById('detalleFecha').textContent = data.fecha || '-';
            document.getElementById('detalleEstado').textContent = (data.estado ? data.estado.charAt(0).toUpperCase() + data.estado.slice(1) : '-');
            document.getElementById('detalleDescripcion').textContent = data.descripcion || '(Sin detalles)';

            // Comentario existente
            if (data.comentario_coordinador && data.comentario_coordinador.trim() !== '') {
                document.getElementById('detalleComentarioExistente').style.display = 'block';
                document.getElementById('detalleComentarioCoordinador').textContent = data.comentario_coordinador;
            } else {
                document.getElementById('detalleComentarioExistente').style.display = 'none';
                document.getElementById('detalleComentarioCoordinador').textContent = '-';
            }

            // asegurar vista detalles visible y acci√≥n oculta
            document.getElementById('modalDetails').style.display = 'block';
            document.getElementById('modalAction').style.display = 'none';
            document.getElementById('modalBack').style.display = 'none';
            document.getElementById('actionComment').value = '';

            // conectar botones para iniciar acci√≥n
            document.getElementById('btnAprobar').onclick = () => startAccion('aprobada');
            document.getElementById('btnRechazar').onclick = () => startAccion('rechazada');

            // abrir modal
            document.getElementById('modalDetalleSolicitud').style.display = 'flex';
        })
        .catch(err => {
            console.error('Error detalle solicitud', err);
            alert('Error al cargar detalle de la solicitud.');
        });
    }

    // iniciar flujo de acci√≥n: mostrar formulario de comentario
    function startAccion(estado) {
        _currentAccion = estado;
        // actualizar UI de acci√≥n
        document.getElementById('accionTipo').textContent = estado === 'aprobada' ? 'Aprobar' : 'Rechazar';
        document.getElementById('modalDetails').style.display = 'none';
        document.getElementById('modalAction').style.display = 'block';
        document.getElementById('modalBack').style.display = 'inline-block';
        // cambiar texto del bot√≥n de env√≠o seg√∫n acci√≥n
        const submitBtn = document.getElementById('submitActionBtn');
        submitBtn.textContent = (estado === 'aprobada') ? 'Enviar y Aprobar' : 'Enviar y Rechazar';
    };

    // volver desde vista acci√≥n a detalles
    document.getElementById('modalBack').addEventListener('click', () => {
        document.getElementById('modalAction').style.display = 'none';
        document.getElementById('modalDetails').style.display = 'block';
        document.getElementById('modalBack').style.display = 'none';
    });

    // cancelar acci√≥n (bot√≥n)
    document.getElementById('cancelActionBtn').addEventListener('click', () => {
        document.getElementById('actionComment').value = '';
        document.getElementById('modalAction').style.display = 'none';
        document.getElementById('modalDetails').style.display = 'block';
        document.getElementById('modalBack').style.display = 'none';
    });

    // env√≠o final de la acci√≥n con comentario
    document.getElementById('submitActionBtn').addEventListener('click', () => {
        const comentario = document.getElementById('actionComment').value.trim();
        if (!comentario) {
            alert('Por favor escriba un comentario antes de continuar.');
            return;
        }
        if (!_currentSolicitudId || !_currentAccion) {
            alert('Solicitud o acci√≥n inv√°lida.');
            return;
        }
        // llamar a la funci√≥n que procesa la solicitud (usa POST)
        const fd = new FormData();
        fd.append('action', 'validar_solicitud');
        fd.append('solicitud_id', _currentSolicitudId);
        fd.append('estado', _currentAccion);
        fd.append('comentario', comentario);
        // opcional: fd.append('aprobador_id', CURRENT_USER_ID); // si dispone de sesi√≥n

        fetch('../php/coordinador_actions.php', {
            method: 'POST',
            body: fd
        })
        .then(r => r.json())
        .then(resp => {
            if (resp.success) {
                mostrarRegistroFeedback('Solicitud procesada exitosamente.', true);
                cerrarModalDetalle();
                cargarSolicitudes();
                cargarSeguimiento();
            } else {
                mostrarRegistroFeedback('No se pudo procesar la solicitud.', false);
            }
        })
        .catch(() => {
            mostrarRegistroFeedback('Error al conectar con el servidor.', false);
        });
    });

    // cerrar modal y limpiar estados
    function cerrarModalDetalle() {
        document.getElementById('modalDetalleSolicitud').style.display = 'none';
        _currentSolicitudId = null;
        _currentAccion = null;
        document.getElementById('actionComment').value = '';
        document.getElementById('modalBack').style.display = 'none';
}

        // Cargar solicitudes, profesores y l√≠neas de √©nfasis al iniciar
		cargarSolicitudes();
		cargarProfesores();
        cargarLineasEnfasis();
        cargarCursos();
        cargarSeguimiento();
    </script>

    <!-- Chatbot widget -->
    <button class="chatbot-button" id="openChat">üí¨</button>
    <div class="chatbot-modal" id="chatModal" style="display:none;">
        <div class="chatbot-header">Asistente del portal</div>
        <div class="chatbot-body" id="chatBody">
            <div class="chatbot-msg bot"><span class="bubble">Hola, ¬ønecesitas ayuda con cursos o solicitudes?</span></div>
        </div>
        <div class="chatbot-input">
            <textarea id="chatInput" placeholder="Escribe tu pregunta..."></textarea>
            <button id="sendChat" style="background:#c41e3a;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">Enviar</button>
        </div>
    </div>

    <script>
    (function(){
        const openBtn = document.getElementById('openChat');
        const modal = document.getElementById('chatModal');
        const sendBtn = document.getElementById('sendChat');
        const input = document.getElementById('chatInput');
        const body = document.getElementById('chatBody');
        const endpoint = '../php/chatbot_api.php';

        openBtn.addEventListener('click', () => {
            modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
        });

        function appendMessage(from, text) {
            const div = document.createElement('div');
            div.className = 'chatbot-msg ' + (from === 'user' ? 'user' : 'bot');
            div.innerHTML = `<span class="bubble">${text}</span>`;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        sendBtn.addEventListener('click', () => {
            const q = input.value.trim();
            if (!q) return;
            appendMessage('user', q);
            input.value = '';
            appendMessage('bot', 'Escribiendo...');

            fetch(endpoint, {
                method: 'POST',
                body: new URLSearchParams({ q })
            })
            .then(r => r.json())
            .then(res => {
                const typing = Array.from(body.querySelectorAll('.chatbot-msg.bot')).pop();
                if (typing && typing.textContent.trim() === 'Escribiendo...') typing.remove();

                if (res.success) {
                    appendMessage('bot', res.answer);
                    if (res.suggestions && Object.keys(res.suggestions).length) {
                        const keys = Object.keys(res.suggestions);
                        const linksHtml = keys.map(k => `<div class="chatbot-suggestion"><a href="${k}">${res.suggestions[k]}</a></div>`).join('');
                        const div = document.createElement('div');
                        div.className = 'chatbot-msg bot';
                        div.innerHTML = `<span class="bubble">${linksHtml}</span>`;
                        body.appendChild(div);
                        body.scrollTop = body.scrollHeight;
                    }
                } else {
                    appendMessage('bot', 'Lo siento, ocurri√≥ un error al procesar tu consulta.');
                }
            })
            .catch(() => {
                appendMessage('bot', 'Error de conexi√≥n. Intenta m√°s tarde.');
            });
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });
    })();
    </script>
</body>
</html>