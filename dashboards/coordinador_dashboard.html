<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Acad√©mica - Universidad de Medell√≠n</title>
    <link rel="stylesheet" href="../CSS/coordinador_dashboard.css">
    <link rel="stylesheet" href="../CSS/chatbot.css">

</head>
<body>
    <!-- Header -->
    <div class="header">
        <img src="../IMG/logo.png" alt="Universidad de Medell√≠n">
          <div class = "button">
            <button onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
          </div>  
      </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Title -->
        <h1 class="page-title">
            Gesti√≥n Acad√©mica de L√≠neas de √ânfasis
            <img src="https://previews.123rf.com/images/michaeljung/michaeljung0906/michaeljung090600290/5125275-teacher.jpg" alt="Icon" class="title-icon">
        </h1>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('registrar')">Registrar Curso</button>
            <button class="nav-tab" onclick="showSection('validar')">Validar Solicitudes</button>
            <button class="nav-tab" onclick="showSection('seguimiento')">Seguimiento Aprobaciones</button>
        </div>

        <!-- Registrar Curso Section -->
        <div id="registrar" class="content-section active">
            <!-- Reemplazado: tarjeta de registro con dise√±o mejorado -->
            <div class="card card--elevated">
                <div class="card-header">
                    <h2 class="section-title">Registrar Nuevo Curso</h2>
                    <p class="card-subtitle">Complete la informaci√≥n del curso. El comentario del profesor es opcional.</p>
                </div>

                <form id="registroCursoForm" class="registro-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label><span class="label-icon">üìò</span> Nombre del Curso</label>
                            <input type="text" id="curso_nombre" name="nombre" placeholder="Ej: C√°lculo Diferencial" required>
                            <div class="helper-text">Nombre descriptivo y claro (m√°x. 150 caracteres).</div>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üîñ</span> C√≥digo del Curso</label>
                            <input type="text" id="curso_codigo" name="codigo" placeholder="Ej: MAT101" required>
                            <div class="helper-text">C√≥digo √∫nico (sin espacios).</div>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üìÖ</span> Semestre</label>
                            <select id="curso_semestre" name="semestre" required>
                                <option value="">Seleccione...</option>
                                <option>2024-1</option>
                                <option>2024-2</option>
                                <option>2025-1</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üë©‚Äçüè´</span> Profesor responsable</label>
                            <select id="profesorSelect" name="profesor_id" required>
                                <option value="">Cargando profesores...</option>
                            </select>
                            <div class="helper-text">Seleccione el docente que dictar√° el curso.</div>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üìö</span> L√≠nea de √ânfasis</label>
                            <select id="lineaEnfasisSelect" name="linea_enfasis_id" required>
                                <option value="">Cargando l√≠neas de √©nfasis...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label><span class="label-icon">üìù</span> Notas/Observaciones (opcional)</label>
                            <input type="text" id="curso_observaciones" name="observaciones" placeholder="Ej: Requiere laboratorio complementario">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-submit">Registrar Curso</button>
                        <div id="registroFeedback" class="feedback" aria-live="polite" style="display:none;"></div>
                    </div>
                </form>
            </div>
            <!-- Nuevo: Filtro por l√≠nea de √©nfasis + lista de cursos (tarjetas) -->
            <div class="card" style="margin-top:30px;">
                <div class="card-header" style="display:flex;flex-direction:column;gap:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
                        <h2 class="section-title" style="margin:0;">Cursos Registrados</h2>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input id="buscarCurso" type="text" placeholder="Buscar por nombre o c√≥digo..." style="padding:10px 12px;border-radius:8px;border:1px solid #e6e6e6;width:260px;">
                            <label for="filtroLineaEnfasis" style="margin:0 6px 0 0;font-weight:600;color:#333;">L√≠nea:</label>
                            <select id="filtroLineaEnfasis" style="padding:10px;border-radius:8px;border:1px solid #e6e6e6;">
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <p class="card-subtitle" style="margin:0;color:#666;font-size:13px;">Busca, filtra y administra los cursos registrados. Haz click en eliminar para borrarlo.</p>
                </div>

                <div id="listaCursos" class="courses-grid" style="margin-top:18px;">
                    <!-- Se generan tarjetas de curso din√°micamente -->
                </div>

                <!-- Tabla de respaldo (oculta) para compatibilidad -->
                <div class="table-container" style="display:none;">
                    <table id="tablaCursos">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>C√≥digo</th>
                                <th>Semestre</th>
                                <th>L√≠nea de √ânfasis</th>
                                <th>Profesor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Se cargan din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Validar Solicitudes Section -->
        <div id="validar" class="content-section">
            <div class="card">
                <h2 class="section-title">Validaci√≥n de Solicitudes</h2>
                <div class="table-container" id="solicitudesPendientes">
                    <table id="tablaSolicitudes" style="width:100%;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Remitente</th>
                                <th>Rol</th>
                                <th>Tipo</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Se carga din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Seguimiento Aprobaciones Section -->
        <div id="seguimiento" class="content-section">
		<div class="filter-group">
			<label>Filtrar por Semestre:</label>
			<select>
				<option>2024-1</option>
				<option>2024-2</option>
				<option>2025-1</option>
			</select>
		</div>

		<div class="seguimiento-container">
			<!-- Lista de Solicitudes procesadas -->
			<div class="solicitudes-list">
				<h2 class="section-title">Listado de Solicitudes (Aprobadas / Rechazadas)</h2>
				<div id="listaSeguimiento">
					<!-- Se llenar√° din√°micamente -->
				</div>
			</div>

			<!-- Panel detalle (visor de una solicitud seleccionada) -->
			<div class="detalles-panel" id="panelDetalleSeguimiento">
				<h2 class="section-title">Detalle</h2>
				<div id="detalleContent">
					<p><b>Tipo:</b> <span id="detalleTipo">-</span></p>
					<p><b>Remitente:</b> <span id="detalleRemitente">-</span></p>
					<p><b>Rol:</b> <span id="detalleRol">-</span></p>
					<p><b>Fecha env√≠o:</b> <span id="detalleFecha">-</span></p>
					<p><b>Estado:</b> <span id="detalleEstado">-</span></p>
					<p><b>Descripci√≥n (remitente):</b></p>
					<p id="detalleDescripcion">-</p>
					<p><b>Comentario del coordinador:</b></p>
					<p id="detalleComentarioCoordinador">-</p>
					<p><b>Aprobado por:</b> <span id="detalleAprobador">-</span></p>
					<p><b>Fecha de procesado:</b> <span id="detalleFechaProcesamiento">-</span></p>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal detalle / validaci√≥n -->
	<div id="modalDetalleSolicitud" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;">
		<div style="background:white;border-radius:8px;padding:20px;max-width:800px;width:95%;max-height:90vh;overflow:auto;position:relative;">
			<button onclick="cerrarModalDetalle()" style="position:absolute;right:12px;top:12px;background:#eee;border:none;padding:8px;border-radius:6px;cursor:pointer;">Cerrar</button>
			<h3>Detalle de Solicitud</h3>
			<p><b>Tipo:</b> <span id="detalleTipo">-</span></p>
			<p><b>Remitente:</b> <span id="detalleRemitente">-</span></p>
			<p><b>Rol:</b> <span id="detalleRol">-</span></p>
			<p><b>Fecha env√≠o:</b> <span id="detalleFecha">-</span></p>
			<p><b>Estado:</b> <span id="detalleEstado">-</span></p>
			<p><b>Descripci√≥n (remitente):</b></p>
			<p id="detalleDescripcion">-</p>

			<!-- Comentario del coordinador (si ya hay) -->
			<div id="detalleComentarioExistente" style="margin-top:10px;display:none;">
				<p><b>Comentario del coordinador:</b></p>
				<p id="detalleComentarioCoordinador">-</p>
			</div>

			<!-- √Årea para dejar comentario al procesar (solo cuando est√° pendiente) -->
			<div id="detalleAcciones" style="margin-top:16px;display:none;">
				<label for="coordinatorComment"><b>Comentario para el remitente (requerido)</b></label>
				<textarea id="coordinatorComment" style="width:100%;min-height:100px;padding:8px;margin-top:8px;border:1px solid #ddd;border-radius:6px;"></textarea>
				<div style="display:flex;gap:10px;margin-top:12px;">
					<button id="btnAprobar" class="btn-action btn-aprobar" style="padding:8px 16px;">Aprobar</button>
					<button id="btnRechazar" class="btn-action btn-rechazar" style="padding:8px 16px;">Rechazar</button>
				</div>
			</div>
		</div>
	</div>

    <script>
        function showSection(sectionId) {
            // Hide all sections
            var sections = document.querySelectorAll('.content-section');
            sections.forEach(function(section) {
                section.classList.remove('active');
            });

            // Remove active class from all tabs
            var tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Funci√≥n para registrar curso
        document.getElementById('registroCursoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const nombre = document.getElementById('curso_nombre').value.trim();
            const codigo = document.getElementById('curso_codigo').value.trim();
            const semestre = document.getElementById('curso_semestre').value;
            const profesor_id = document.getElementById('profesorSelect').value;
            const linea_enfasis_id = document.getElementById('lineaEnfasisSelect').value;

            if (!nombre || !codigo || !semestre || !profesor_id || !linea_enfasis_id) {
                alert('Complete todos los campos del formulario.');
                return;
            }

            const formData = new FormData();
            formData.append('action', 'registrar_curso');
            formData.append('nombre', nombre);
            formData.append('codigo', codigo);
            formData.append('semestre', semestre);
            formData.append('profesor_id', profesor_id);
            formData.append('linea_enfasis_id', linea_enfasis_id);

            fetch('../php/coordinador_actions.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    alert('Curso registrado correctamente.');
                    this.reset();
                    cargarCursos(); // <--- recarga la tabla
                } else {
                    alert('Error: ' + (resp.message || 'No fue posible registrar el curso.'));
                }
            })
            .catch(err => {
                console.error('Error registrar curso', err);
                alert('Error al conectar con el servidor.');
            });
        });

        // Cargar solicitudes en tabla
        function cargarSolicitudes() {
            fetch('../php/coordinador_actions.php?action=obtener_solicitudes')
            .then(response => response.json())
            .then(solicitudes => {
                const tbody = document.querySelector('#tablaSolicitudes tbody');
                if (!Array.isArray(solicitudes) || solicitudes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">No hay solicitudes registradas.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                solicitudes.forEach(solicitud => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${solicitud.id}</td>
                        <td>${solicitud.remitente}</td>
                        <td>${solicitud.rol}</td>
                        <td>${solicitud.tipo}</td>
                        <td>${solicitud.fecha}</td>
                        <td>
                            <span class="status-badge status-${solicitud.estado}">${solicitud.estado.charAt(0).toUpperCase() + solicitud.estado.slice(1)}</span>
                        </td>
                        <td>
                            <button class="btn-action" style="padding:4px 12px;" onclick="verDetalleSolicitud(${solicitud.id})">Ver</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(() => {
                document.querySelector('#tablaSolicitudes tbody').innerHTML = '<tr><td colspan="7">Error al cargar las solicitudes.</td></tr>';
            });
        }

        // Mostrar modal con detalle de solicitud
    function verDetalleSolicitud(id) {
        fetch(`../php/coordinador_actions.php?action=detalle_solicitud&id=${id}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('detalleTipo').textContent = data.tipo || '-';
            document.getElementById('detalleRemitente').textContent = data.remitente || '-';
            document.getElementById('detalleRol').textContent = data.rol || '-';
            document.getElementById('detalleFecha').textContent = data.fecha || '-';
            document.getElementById('detalleEstado').textContent = (data.estado ? data.estado.charAt(0).toUpperCase() + data.estado.slice(1) : '-');
            document.getElementById('detalleDescripcion').textContent = data.descripcion || '(Sin detalles)';

            // Comentario del coordinador (si existe)
            if (data.comentario_coordinador && data.comentario_coordinador.trim() !== '') {
                document.getElementById('detalleComentarioExistente').style.display = 'block';
                document.getElementById('detalleComentarioCoordinador').textContent = data.comentario_coordinador;
            } else {
                document.getElementById('detalleComentarioExistente').style.display = 'none';
                document.getElementById('detalleComentarioCoordinador').textContent = '-';
            }

            // Mostrar/ocultar botones seg√∫n estado
            if (data.estado === 'pendiente') {
                document.getElementById('detalleAcciones').style.display = 'block';
                document.getElementById('coordinatorComment').value = '';
                document.getElementById('btnAprobar').onclick = function() { procesarSolicitud(data.id, 'aprobada'); };
                document.getElementById('btnRechazar').onclick = function() { procesarSolicitud(data.id, 'rechazada'); };
            } else {
                document.getElementById('detalleAcciones').style.display = 'none';
            }

            // Mostrar modal y limpiar posibles campos
            document.getElementById('modalDetalleSolicitud').style.display = 'flex';
        });
    }

    function cerrarModalDetalle() {
        document.getElementById('modalDetalleSolicitud').style.display = 'none';
    }

    // Procesar solicitud (aprobar/rechazar) con comentario
    function procesarSolicitud(id, estado) {
        const comentario = document.getElementById('coordinatorComment').value.trim();
        if (!comentario) {
            alert('Por favor deje un comentario antes de procesar la solicitud.');
            return;
        }
        const formData = new FormData();
        formData.append('action', 'validar_solicitud');
        formData.append('solicitud_id', id);
        formData.append('estado', estado);
        formData.append('comentario', comentario);
        // Si se dispone de id de coordinador en frontend, se puede anexar:
        // formData.append('aprobador_id', 123);

        fetch('../php/coordinador_actions.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                alert('Solicitud procesada exitosamente');
                cerrarModalDetalle();
                cargarSolicitudes();
                cargarSeguimiento(); // actualizar seguimiento
            } else {
                alert('Error al procesar la solicitud');
            }
        })
        .catch(err => {
            console.error('Error validar solicitud', err);
            alert('Error al conectar con el servidor.');
        });
    }

    // Cargar seguimiento (solicitudes aprobadas/rechazadas)
		function cargarSeguimiento() {
			fetch('../php/coordinador_actions.php?action=list_solicitudes_procesadas')
			.then(res => res.json())
			.then(data => {
				const cont = document.getElementById('listaSeguimiento');
				if (!Array.isArray(data) || data.length === 0) {
					cont.innerHTML = '<p>No hay solicitudes procesadas.</p>';
					return;
				}
				cont.innerHTML = '';
				data.forEach(s => {
					const div = document.createElement('div');
					div.className = 'historial-item';
					div.style.marginBottom = '12px';
					div.innerHTML = `
						<div style="display:flex;justify-content:space-between;align-items:center;">
							<div>
								<b>(${s.estado.toUpperCase()})</b> ${s.tipo} ‚Äî <span style="color:#666">${s.remitente}</span>
								<div style="font-size:13px;color:#999;margin-top:6px;">Enviado: ${s.fecha} ‚Ä¢ Procesado: ${s.fecha_procesamiento || '-'}</div>
							</div>
							<div style="text-align:right;">
								<div style="font-size:13px;color:#333;">${s.aprobador_nombre ? s.aprobador_nombre : '‚Äî'}</div>
								<button class="btn-action" style="margin-top:8px;padding:6px 10px;" onclick="verDetalleSolicitud(${s.id})">Ver</button>
							</div>
						</div>
						<div style="margin-top:8px;">
							<p style="margin:0;"><b>Descripci√≥n (remitente):</b></p>
							<p style="margin:0;color:#444;">${s.descripcion || '(Sin descripci√≥n)'}</p>
							<div style="margin-top:8px;">
								<p style="margin:0;"><b>Comentario del coordinador:</b></p>
								<p style="margin:0;color:#444;">${s.comentario_coordinador || '(Sin comentario)'}</p>
							</div>
						</div>
					`;
					cont.appendChild(div);
				});
			})
			.catch(err => {
				console.error('Error cargar seguimiento', err);
				document.getElementById('listaSeguimiento').innerHTML = '<p>Error al cargar seguimiento.</p>';
			});
		}

        // Cerrar sesi√≥n
        function cerrarSesion() {
            fetch('../api/logout.php')
            .then(() => {
                window.location.href = '../index.html';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cerrar sesi√≥n');
            });
        }

        // Cargar lista de profesores desde el servidor
		function cargarProfesores() {
			const select = document.getElementById('profesorSelect');
			select.innerHTML = '<option value="">Cargando profesores...</option>';

			fetch('../php/coordinador_actions.php?action=list_profesores')
			.then(res => res.json())
			.then(data => {
				if (!Array.isArray(data)) {
					select.innerHTML = '<option value="">No se encontraron profesores</option>';
					return;
				}
				select.innerHTML = '<option value="">Seleccione un profesor</option>';
				data.forEach(prof => {
					const opt = document.createElement('option');
					opt.value = prof.id;
					opt.textContent = prof.nombre + ' (' + prof.documento + ')';
					select.appendChild(opt);
				});
			})
			.catch(err => {
				console.error('Error cargando profesores', err);
				select.innerHTML = '<option value="">Error al cargar profesores</option>';
			});
		}

        // Cargar l√≠neas de √©nfasis en ambos selects
        function cargarLineasEnfasis() {
            fetch('../php/coordinador_actions.php?action=list_lineas_enfasis')
            .then(res => res.json())
            .then(data => {
                // Para el formulario de registro
                const selectForm = document.getElementById('lineaEnfasisSelect');
                selectForm.innerHTML = '<option value="">Seleccione una l√≠nea de √©nfasis</option>';
                data.forEach(le => {
                    const opt = document.createElement('option');
                    opt.value = le.id;
                    opt.textContent = le.nombre;
                    selectForm.appendChild(opt);
                });
                // Para el filtro
                const selectFiltro = document.getElementById('filtroLineaEnfasis');
                selectFiltro.innerHTML = '<option value="">Todas</option>';
                data.forEach(le => {
                    const opt = document.createElement('option');
                    opt.value = le.id;
                    opt.textContent = le.nombre;
                    selectFiltro.appendChild(opt);
                });
            });
        }

        // Reemplazado: funci√≥n cargarCursos ahora renderiza tarjetas y aplica b√∫squeda local
        function cargarCursos() {
            const filtroLinea = document.getElementById('filtroLineaEnfasis').value;
            let url = '../php/coordinador_actions.php?action=list_cursos';
            if (filtroLinea) url += '&linea_enfasis_id=' + encodeURIComponent(filtroLinea);

            fetch(url)
            .then(res => res.json())
            .then(data => {
                const cont = document.getElementById('listaCursos');
                // limpiar
                cont.innerHTML = '';

                if (!Array.isArray(data) || data.length === 0) {
                    cont.innerHTML = '<p style="color:#666;">No hay cursos registrados.</p>';
                    return;
                }

                data.forEach(curso => {
                    const card = document.createElement('div');
                    card.className = 'course-card';
                    card.innerHTML = `
                        <div class="course-card-body">
                            <div class="course-title">${escapeHtml(curso.nombre)}</div>
                            <div class="course-meta">
                                <span class="course-code">${escapeHtml(curso.codigo)}</span>
                                <span class="course-semestre">${escapeHtml(curso.semestre)}</span>
                                <span class="course-linea">${escapeHtml(curso.linea_enfasis_nombre)}</span>
                            </div>
                            <div class="course-prof">Profesor: <b>${escapeHtml(curso.profesor_nombre)}</b></div>
                        </div>
                        <div class="course-actions">
                            <button class="btn-action btn-rechazar" onclick="eliminarCurso(${curso.id}, this)">Eliminar</button>
                        </div>
                    `;
                    cont.appendChild(card);
                });

                // aplicar filtro de b√∫squeda local si hay texto
                aplicarFiltroBusqueda();
            })
            .catch(err => {
                console.error('Error cargar cursos', err);
                document.getElementById('listaCursos').innerHTML = '<p style="color:#c00;">Error al cargar los cursos.</p>';
            });
        }

        // Util: escapar texto para evitar inyecci√≥n en HTML
        function escapeHtml(text) {
            if (!text && text !== 0) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Buscar en cliente
        document.getElementById('buscarCurso').addEventListener('input', aplicarFiltroBusqueda);

        function aplicarFiltroBusqueda() {
            const q = document.getElementById('buscarCurso').value.trim().toLowerCase();
            const cont = document.getElementById('listaCursos');
            Array.from(cont.children).forEach(card => {
                const texto = card.innerText.toLowerCase();
                card.style.display = q === '' || texto.indexOf(q) !== -1 ? 'flex' : 'none';
            });
        }

        // Ajustar eliminarCurso para mostrar feedback dentro del UI (y recibir bot√≥n)
        function eliminarCurso(id, btn) {
            if (!confirm('¬øSeguro que deseas eliminar este curso?')) return;
            const formData = new FormData();
            formData.append('action', 'eliminar_curso');
            formData.append('curso_id', id);

            // peque√±o indicador
            const original = btn.innerHTML;
            btn.disabled = true;
            btn.innerText = 'Eliminando...';

            fetch('../php/coordinador_actions.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    // mostrar feedback temporal
                    mostrarRegistroFeedback('Curso eliminado correctamente.', true);
                    // recargar lista
                    cargarCursos();
                } else {
                    mostrarRegistroFeedback('No se pudo eliminar el curso.', false);
                    btn.disabled = false;
                    btn.innerHTML = original;
                }
            })
            .catch(() => {
                mostrarRegistroFeedback('Error al conectar con el servidor.', false);
                btn.disabled = false;
                btn.innerHTML = original;
            });
        }

        // Mostrar feedback en el panel de registro (usa el div registroFeedback si existe)
        function mostrarRegistroFeedback(text, ok) {
            const fb = document.getElementById('registroFeedback');
            if (!fb) {
                alert(text);
                return;
            }
            fb.style.display = 'block';
            fb.style.color = ok ? '#155724' : '#721c24';
            fb.style.background = ok ? '#e6f4ea' : '#fdecea';
            fb.style.borderColor = ok ? '#c8e6d6' : '#f5c6cb';
            fb.textContent = text;
            setTimeout(() => { fb.style.display = 'none'; }, 3000);
        }

        // Escuchar cambio de filtro de l√≠nea para recargar
        document.getElementById('filtroLineaEnfasis').addEventListener('change', function() {
            cargarCursos();
        });

        // Cargar solicitudes, profesores y l√≠neas de √©nfasis al iniciar
		cargarSolicitudes();
		cargarProfesores();
        cargarLineasEnfasis();
        cargarCursos();
        cargarSeguimiento();
    </script>

    <!-- Chatbot widget -->
    <button class="chatbot-button" id="openChat">üí¨</button>
    <div class="chatbot-modal" id="chatModal" style="display:none;">
        <div class="chatbot-header">Asistente del portal</div>
        <div class="chatbot-body" id="chatBody">
            <div class="chatbot-msg bot"><span class="bubble">Hola, ¬ønecesitas ayuda con cursos o solicitudes?</span></div>
        </div>
        <div class="chatbot-input">
            <textarea id="chatInput" placeholder="Escribe tu pregunta..."></textarea>
            <button id="sendChat" style="background:#c41e3a;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">Enviar</button>
        </div>
    </div>

    <script>
    (function(){
        const openBtn = document.getElementById('openChat');
        const modal = document.getElementById('chatModal');
        const sendBtn = document.getElementById('sendChat');
        const input = document.getElementById('chatInput');
        const body = document.getElementById('chatBody');
        const endpoint = '../php/chatbot_api.php';

        openBtn.addEventListener('click', () => {
            modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
        });

        function appendMessage(from, text) {
            const div = document.createElement('div');
            div.className = 'chatbot-msg ' + (from === 'user' ? 'user' : 'bot');
            div.innerHTML = `<span class="bubble">${text}</span>`;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

        sendBtn.addEventListener('click', () => {
            const q = input.value.trim();
            if (!q) return;
            appendMessage('user', q);
            input.value = '';
            appendMessage('bot', 'Escribiendo...');

            fetch(endpoint, {
                method: 'POST',
                body: new URLSearchParams({ q })
            })
            .then(r => r.json())
            .then(res => {
                const typing = Array.from(body.querySelectorAll('.chatbot-msg.bot')).pop();
                if (typing && typing.textContent.trim() === 'Escribiendo...') typing.remove();

                if (res.success) {
                    appendMessage('bot', res.answer);
                    if (res.suggestions && Object.keys(res.suggestions).length) {
                        const keys = Object.keys(res.suggestions);
                        const linksHtml = keys.map(k => `<div class="chatbot-suggestion"><a href="${k}">${res.suggestions[k]}</a></div>`).join('');
                        const div = document.createElement('div');
                        div.className = 'chatbot-msg bot';
                        div.innerHTML = `<span class="bubble">${linksHtml}</span>`;
                        body.appendChild(div);
                        body.scrollTop = body.scrollHeight;
                    }
                } else {
                    appendMessage('bot', 'Lo siento, ocurri√≥ un error al procesar tu consulta.');
                }
            })
            .catch(() => {
                appendMessage('bot', 'Error de conexi√≥n. Intenta m√°s tarde.');
            });
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });
    })();
    </script>
</body>
</html>